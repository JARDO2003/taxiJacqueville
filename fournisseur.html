<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TAXI MOTO EXPRESS - Espace Chauffeur</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    <!-- Leaflet Routing Machine CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet-routing-machine/3.2.12/leaflet-routing-machine.css" />
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        header {
            background-color: #ffcc00;
            color: #222;
            padding: 15px 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            font-size: 24px;
            font-weight: bold;
            display: flex;
            align-items: center;
        }
        
        .logo i {
            margin-right: 10px;
            font-size: 28px;
        }
        
        .driver-info {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-top: 30px;
            margin-bottom: 20px;
        }

        .driver-info h2 {
            margin-bottom: 15px;
            color: #333;
        }

        .registration-form {
            background-color: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-top: 30px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #444;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }

        .orders-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .order-card {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }
        
        .order-card.accepted {
            background-color: #f0f0f0;
            opacity: 0.7;
            position: relative;
        }
        
        .order-card.accepted::after {
            content: 'COMMANDE NON DISPONIBLE';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            text-align: center;
            font-weight: bold;
            color: #e74c3c;
            font-size: 18px;
            transform: translateY(-50%) rotate(-15deg);
        }
        
        .order-card:hover {
            transform: translateY(-5px);
        }
        
        .order-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .order-id {
            font-weight: 600;
            color: #555;
        }
        
        .order-time {
            color: #777;
        }
        
        .order-details {
            margin-bottom: 15px;
        }
        
        .detail-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        
        .detail-label {
            font-weight: 500;
            color: #555;
        }
        
        .detail-value {
            color: #333;
        }
        
        .order-address {
            margin-bottom: 15px;
            color: #555;
            line-height: 1.4;
        }
        
        .btn {
            background-color: #ffcc00;
            color: #222;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            font-weight: 600;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
            display: block;
            width: 100%;
            text-align: center;
            text-decoration: none;
        }
        
        .btn:hover {
            background-color: #f0c000;
        }
        
        .btn-disabled {
            background-color: #ddd;
            color: #999;
            cursor: not-allowed;
        }
        
        .btn-disabled:hover {
            background-color: #ddd;
        }
        
        .map-container {
            display: none;
            margin-top: 30px;
            margin-bottom: 30px;
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        #map {
            height: 500px;
            width: 100%;
            border-radius: 5px;
        }
        
        .current-order {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .current-order h3 {
            margin-bottom: 15px;
            color: #333;
        }
        
        .order-status {
            display: flex;
            justify-content: space-around;
            margin-top: 20px;
        }
        
        .status-btn {
            flex: 1;
            margin: 0 10px;
        }
        
        .btn-success {
            background-color: #2ecc71;
        }
        
        .btn-success:hover {
            background-color: #27ae60;
        }
        
        .btn-danger {
            background-color: #e74c3c;
        }
        
        .btn-danger:hover {
            background-color: #c0392b;
        }
        
        .info-note {
            background-color: #f8f9fa;
            border-left: 4px solid #ffcc00;
            padding: 15px;
            margin-bottom: 20px;
            color: #555;
            line-height: 1.5;
        }
        
        .bike-marker {
            font-size: 24px;
            color: #ffcc00;
            text-shadow: -1px 0 black, 0 1px black, 1px 0 black, 0 -1px black;
        }
        
        footer {
            background-color: #222;
            color: white;
            padding: 30px 0;
            text-align: center;
            margin-top: 50px;
        }
        
        .copyright {
            color: #aaa;
        }
        
        @media (max-width: 768px) {
            .orders-container {
                grid-template-columns: 1fr;
            }
            
            .order-status {
                flex-direction: column;
                gap: 10px;
            }
            
            .status-btn {
                margin: 5px 0;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container header-content">
            <div class="logo">
                <i class="fas fa-motorcycle"></i> TAXI MOTO EXPRESS
            </div>
            <div>
                <span id="driverStatusDisplay">Espace Chauffeur</span>
            </div>
        </div>
    </header>
    
    <main class="container">
        <!-- Formulaire d'inscription du chauffeur -->
        <div id="registrationForm" class="registration-form">
            <h2>Inscription Chauffeur</h2>
            <p class="info-note">Veuillez vous inscrire pour accéder aux commandes disponibles.</p>
            
            <div class="form-group">
                <label for="driverName">Nom complet</label>
                <input type="text" id="driverName" placeholder="Entrez votre nom complet">
            </div>
            
            <div class="form-group">
                <label for="driverPhone">Numéro de téléphone</label>
                <input type="tel" id="driverPhone" placeholder="Entrez votre numéro de téléphone">
            </div>
            
            <div class="form-group">
                <label for="vehicleModel">Modèle de moto</label>
                <input type="text" id="vehicleModel" placeholder="Entrez le modèle de votre moto">
            </div>
            
            <div class="form-group">
                <label for="vehicleNumber">Plaque d'immatriculation</label>
                <input type="text" id="vehicleNumber" placeholder="Entrez votre plaque d'immatriculation">
            </div>
            
            <button class="btn" id="registerDriverBtn">S'inscrire</button>
        </div>
        
        <!-- Informations du chauffeur -->
        <div id="driverInfoDisplay" class="driver-info" style="display: none;">
            <h2>Informations du chauffeur</h2>
            <div class="detail-row">
                <span class="detail-label">Nom:</span>
                <span class="detail-value" id="displayDriverName">--</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Téléphone:</span>
                <span class="detail-value" id="displayDriverPhone">--</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Moto:</span>
                <span class="detail-value" id="displayVehicleModel">--</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Plaque:</span>
                <span class="detail-value" id="displayVehicleNumber">--</span>
            </div>
        </div>
        
        <!-- Commande en cours -->
        <div id="currentOrderContainer" class="current-order" style="display: none;">
            <h3>Commande en cours</h3>
            <div class="order-details">
                <div class="detail-row">
                    <span class="detail-label">ID de commande:</span>
                    <span class="detail-value" id="currentOrderId">--</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Distance:</span>
                    <span class="detail-value" id="currentOrderDistance">--</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Prix:</span>
                    <span class="detail-value" id="currentOrderPrice">--</span>
                </div>
            </div>
            
            <div class="order-address">
                <strong>Point de départ:</strong> <span id="currentOrderPickup">--</span>
            </div>
            <div class="order-address">
                <strong>Destination:</strong> <span id="currentOrderDestination">--</span>
            </div>
            
            <div class="order-status">
                <button class="btn status-btn" id="arrivedBtn">Arrivé au point de départ</button>
                <button class="btn status-btn" id="startedBtn">Course commencée</button>
                <button class="btn status-btn btn-success" id="completedBtn">Course terminée</button>
                <button class="btn status-btn btn-danger" id="cancelBtn">Annuler</button>
            </div>
        </div>
        
        <!-- Carte pour le suivi de la course -->
        <div id="mapContainer" class="map-container">
            <h2>Suivi de la course</h2>
            <div id="map"></div>
        </div>
        
        <!-- Liste des commandes -->
        <h2>Commandes disponibles</h2>
        <p class="info-note">Cliquez sur "Accepter" pour prendre en charge une commande.</p>
        <div id="ordersContainer" class="orders-container">
            <!-- Les commandes seront ajoutées ici dynamiquement -->
            <div class="order-card">
                <div class="order-header">
                    <span class="order-id">Chargement des commandes...</span>
                </div>
            </div>
        </div>
    </main>
    
    <footer>
        <div class="container">
            <div class="copyright">
                <p>&copy; 2025 TAXI MOTO EXPRESS - Espace Chauffeur</p>
            </div>
        </div>
    </footer>

    <!-- Leaflet JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <!-- Leaflet Routing Machine -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-routing-machine/3.2.12/leaflet-routing-machine.min.js"></script>
    <script>
        // Configuration Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBZOjPxnWZ7w9A5MdKulPSsuEcQMzj6u98",
            authDomain: "transport-a8225.firebaseapp.com",
            databaseURL: "https://transport-a8225-default-rtdb.firebaseio.com",
            projectId: "transport-a8225",
            storageBucket: "transport-a8225.firebasestorage.app",
            messagingSenderId: "268859727706",
            appId: "1:268859727706:web:3368b93a20826281799d63",
            measurementId: "G-PE30CHJ409"
        };
        
        // Initialiser Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        // Variables globales
        let map;
        let routingControl;
        let bikeMarker;
        let currentPosition;
        let driverId;
        let currentOrderId = null;
        
        // Vérifier si le chauffeur est déjà inscrit
        function checkDriverRegistration() {
            const storedDriverData = localStorage.getItem('taxiMotoDriverData');
            
            if (storedDriverData) {
                const driverData = JSON.parse(storedDriverData);
                driverId = driverData.id;
                
                // Remplir les informations du chauffeur
                document.getElementById('displayDriverName').textContent = driverData.name;
                document.getElementById('displayDriverPhone').textContent = driverData.phone;
                document.getElementById('displayVehicleModel').textContent = driverData.vehicleModel;
                document.getElementById('displayVehicleNumber').textContent = driverData.vehicleNumber;
                
                // Masquer le formulaire et afficher les informations
                document.getElementById('registrationForm').style.display = 'none';
                document.getElementById('driverInfoDisplay').style.display = 'block';
                
                // Vérifier si le chauffeur a une commande en cours
                checkForActiveOrder(driverId);
                
                // Charger les commandes disponibles
                loadAvailableOrders();
                
                // Initialiser la carte
                initMap();
                
                return true;
            }
            
            return false;
        }
        
        // Inscrire un nouveau chauffeur
        function registerDriver() {
            const name = document.getElementById('driverName').value.trim();
            const phone = document.getElementById('driverPhone').value.trim();
            const vehicleModel = document.getElementById('vehicleModel').value.trim();
            const vehicleNumber = document.getElementById('vehicleNumber').value.trim();
            
            // Validation simple
            if (!name || !phone || !vehicleModel || !vehicleNumber) {
                alert('Veuillez remplir tous les champs');
                return;
            }
            
            // Générer un ID unique pour le chauffeur
            const newDriverId = 'driver_' + Date.now();
            
            // Créer l'objet chauffeur
            const driverData = {
                id: newDriverId,
                name: name,
                phone: phone,
                vehicleModel: vehicleModel,
                vehicleNumber: vehicleNumber,
                status: 'available',
                registeredAt: firebase.database.ServerValue.TIMESTAMP
            };
            
            // Enregistrer dans Firebase
            database.ref('drivers/' + newDriverId).set(driverData)
                .then(() => {
                    // Stocker localement
                    localStorage.setItem('taxiMotoDriverData', JSON.stringify(driverData));
                    
                    // Mettre à jour l'interface
                    driverId = newDriverId;
                    document.getElementById('displayDriverName').textContent = name;
                    document.getElementById('displayDriverPhone').textContent = phone;
                    document.getElementById('displayVehicleModel').textContent = vehicleModel;
                    document.getElementById('displayVehicleNumber').textContent = vehicleNumber;
                    
                    // Masquer le formulaire et afficher les informations
                    document.getElementById('registrationForm').style.display = 'none';
                    document.getElementById('driverInfoDisplay').style.display = 'block';
                    
                    // Charger les commandes disponibles
                    loadAvailableOrders();
                    
                    // Initialiser la carte
                    initMap();
                })
                .catch((error) => {
                    console.error('Erreur lors de l\'inscription:', error);
                    alert('Une erreur est survenue lors de l\'inscription. Veuillez réessayer.');
                });
        }
        
        // Vérifier si le chauffeur a une commande active
        function checkForActiveOrder(driverId) {
            database.ref('orders').orderByChild('driver/id').equalTo(driverId).once('value')
                .then((snapshot) => {
                    if (snapshot.exists()) {
                        snapshot.forEach((childSnapshot) => {
                            const orderData = childSnapshot.val();
                            
                            // Vérifier si la commande est en cours (pas terminée ou annulée)
                            if (orderData.status !== 'completed' && orderData.status !== 'cancelled') {
                                currentOrderId = childSnapshot.key;
                                displayCurrentOrder(orderData);
                                
                                // Afficher la carte et configurer l'itinéraire
                                showMapWithRoute(orderData.route.pickupCoords, orderData.route.destinationCoords);
                            }
                        });
                    }
                })
                .catch((error) => {
                    console.error('Erreur lors de la vérification des commandes actives:', error);
                });
        }
        
        // Charger les commandes disponibles
        function loadAvailableOrders() {
            const ordersContainer = document.getElementById('ordersContainer');
            ordersContainer.innerHTML = '';
            
            database.ref('orders').orderByChild('status').equalTo('new').on('value', (snapshot) => {
                ordersContainer.innerHTML = '';
                
                if (snapshot.exists()) {
                    let hasOrders = false;
                    
                    snapshot.forEach((childSnapshot) => {
                        const orderId = childSnapshot.key;
                        const orderData = childSnapshot.val();
                        
                        if (orderData) {
                            hasOrders = true;
                            
                            // Formater l'heure
                            const orderTime = new Date(orderData.timestamp).toLocaleTimeString('fr-FR', {
                                hour: '2-digit',
                                minute: '2-digit'
                            });
                            
                            // Créer la carte de commande
                            const orderCard = document.createElement('div');
                            orderCard.className = 'order-card';
                            orderCard.innerHTML = `
                                <div class="order-header">
                                    <span class="order-id">Commande #${orderId.slice(-6)}</span>
                                    <span class="order-time">${orderTime}</span>
                                </div>
                                <div class="order-details">
                                    <div class="detail-row">
                                        <span class="detail-label">Distance:</span>
                                        <span class="detail-value">${orderData.route.distance.toFixed(2)} km</span>
                                    </div>
                                    <div class="detail-row">
                                        <span class="detail-label">Durée estimée:</span>
                                        <span class="detail-value">${orderData.route.duration} min</span>
                                    </div>
                                    <div class="detail-row">
                                        <span class="detail-label">Prix:</span>
                                        <span class="detail-value">${orderData.route.price} FCFA</span>
                                    </div>
                                </div>
                                <div class="order-address">
                                    <strong>Départ:</strong> ${shortenAddress(orderData.route.pickup)}
                                </div>
                                <div class="order-address">
                                    <strong>Destination:</strong> ${shortenAddress(orderData.route.destination)}
                                </div>
                                <button class="btn" data-order-id="${orderId}">Accepter la course</button>
                            `;
                            
                            // Ajouter l'écouteur d'événement pour le bouton
                            const acceptButton = orderCard.querySelector('.btn');
                            acceptButton.addEventListener('click', () => acceptOrder(orderId, orderData));
                            
                            // Ajouter la carte à la liste
                            ordersContainer.appendChild(orderCard);
                        }
                    });
                    
                    if (!hasOrders) {
                        ordersContainer.innerHTML = '<p>Aucune commande disponible pour le moment.</p>';
                    }
                } else {
                    ordersContainer.innerHTML = '<p>Aucune commande disponible pour le moment.</p>';
                }
            });
            
            // Écouter les commandes qui ne sont plus disponibles
            database.ref('orders').on('child_changed', (snapshot) => {
                const orderId = snapshot.key;
                const orderData = snapshot.val();
                
                if (orderData.status !== 'new') {
                    // Trouver la carte correspondante et la marquer comme acceptée
                    const orderCard = document.querySelector(`.order-card .btn[data-order-id="${orderId}"]`);
                    if (orderCard) {
                        const parentCard = orderCard.closest('.order-card');
                        parentCard.classList.add('accepted');
                        orderCard.classList.add('btn-disabled');
                        orderCard.textContent = 'Non disponible';
                        orderCard.disabled = true;
                    }
                }
            });
        }
        
        // Raccourcir les adresses longues
        function shortenAddress(address) {
            if (address.length > 50) {
                return address.substring(0, 50) + '...';
            }
            return address;
        }
        
        // Accepter une commande
        function acceptOrder(orderId, orderData) {
            if (currentOrderId) {
                alert('Vous avez déjà une commande en cours. Terminez-la avant d\'en accepter une nouvelle.');
                return;
            }
            
            // Mettre à jour le statut de la commande
            database.ref('orders/' + orderId).update({
                status: 'assigned',
                driver: {
                    id: driverId,
                    name: document.getElementById('displayDriverName').textContent,
                    phone: document.getElementById('displayDriverPhone').textContent,
                    vehicleModel: document.getElementById('displayVehicleModel').textContent,
                    vehicleNumber: document.getElementById('displayVehicleNumber').textContent,
                    eta: '10-15 minutes'
                }
            })
            .then(() => {
                // Mettre à jour le statut du chauffeur
                database.ref('drivers/' + driverId).update({
                    status: 'busy',
                    currentOrder: orderId
                });
                
                // Définir la commande en cours
                currentOrderId = orderId;
                displayCurrentOrder(orderData);
                
                // Afficher la carte et configurer l'itinéraire
                showMapWithRoute(orderData.route.pickupCoords, orderData.route.destinationCoords);
            })
            .catch((error) => {
                console.error('Erreur lors de l\'acceptation de la commande:', error);
                alert('Une erreur est survenue lors de l\'acceptation de la commande. Veuillez réessayer.');
            });
        }
        
        // Afficher les détails de la commande en cours
        function displayCurrentOrder(orderData) {
            const currentOrderContainer = document.getElementById('currentOrderContainer');
            currentOrderContainer.style.display = 'block';
            
            document.getElementById('currentOrderId').textContent = currentOrderId.slice(-6);
            document.getElementById('currentOrderDistance').textContent = orderData.route.distance.toFixed(2) + ' km';
            document.getElementById('currentOrderPrice').textContent = orderData.route.price + ' FCFA';
            document.getElementById('currentOrderPickup').textContent = orderData.route.pickup;
            document.getElementById('currentOrderDestination').textContent = orderData.route.destination;
        }
        
        // Initialiser la carte
        function initMap() {
            // Coordonnées par défaut (centrer sur une ville africaine)
            const defaultLocation = [9.5370, -13.6782]; // Conakry, Guinée
            
            // Obtenir la position actuelle
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        currentPosition = [position.coords.latitude, position.coords.longitude];
                        
                        // Créer la carte avec la position actuelle
                        createMap(currentPosition);
                        
                        // Démarrer le suivi de position
                        startPositionTracking();
                    },
                    (error) => {
                        console.error('Erreur de géolocalisation:', error);
                        // En cas d'erreur, utiliser la position par défaut
                        createMap(defaultLocation);
                    }
                );
            } else {
                console.error('La géolocalisation n\'est pas prise en charge par ce navigateur.');
                createMap(defaultLocation);
            }
        }
        
        // Créer la carte Leaflet
        function createMap(position) {
            const mapContainer = document.getElementById('mapContainer');
            
            // Ne créer la carte que si elle n'existe pas déjà
            if (!map) {
                mapContainer.style.display = 'block';
                
                // Créer la carte
                map = L.map('map').setView(position, 15);
                
                // Ajouter la couche de tuiles OpenStreetMap
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                    maxZoom: 19
                }).addTo(map);
                
                // Créer l'icône personnalisée pour la moto
                const BikeIcon = L.divIcon({
                    html: '<i class="fas fa-motorcycle bike-marker"></i>',
                    className: '',
                    iconSize: [24, 24],
                    iconAnchor: [12, 12]
                });
                
                // Ajouter le marqueur de la moto
                bikeMarker = L.marker(position, { icon: BikeIcon }).addTo(map);
            } else {
                // Mettre à jour la position de la carte et du marqueur
                map.setView(position, 15);
                
                if (bikeMarker) {
                    bikeMarker.setLatLng(position);
                }
            }
        }
        
        // Démarrer le suivi de position en temps réel
        function startPositionTracking() {
            if (navigator.geolocation) {
                const watchId = navigator.geolocation.watchPosition(
                    (position) => {
                        const newPosition = [position.coords.latitude, position.coords.longitude];
                        
                        // Mettre à jour la position du marqueur de moto
                        if (bikeMarker) {
                            bikeMarker.setLatLng(newPosition);
                        }
                        
                        // Si une commande est en cours, mettre à jour la position dans Firebase
                        if (currentOrderId) {
                            database.ref('orders/' + currentOrderId + '/driver/currentPosition').set({
                               lat: position.coords.latitude,
                                lng: position.coords.longitude,
                                timestamp: Date.now()
                            });
                        }
                        
                        // Sauvegarder la position actuelle
                        currentPosition = newPosition;
                    },
                    (error) => {
                        console.error('Erreur lors du suivi de position:', error);
                    },
                    {
                        enableHighAccuracy: true,
                        maximumAge: 0,
                        timeout: 5000
                    }
                );
                
                // Stocker l'ID pour pouvoir arrêter le suivi plus tard si nécessaire
                localStorage.setItem('positionWatchId', watchId);
            }
        }
        
        // Afficher la carte avec un itinéraire
        function showMapWithRoute(pickupCoords, destinationCoords) {
            const mapContainer = document.getElementById('mapContainer');
            mapContainer.style.display = 'block';
            
            // S'assurer que la carte est initialisée
            if (!map) {
                initMap();
                setTimeout(() => {
                    addRouteToMap(pickupCoords, destinationCoords);
                }, 1000);
            } else {
                addRouteToMap(pickupCoords, destinationCoords);
            }
        }
        
        // Ajouter un itinéraire à la carte
        function addRouteToMap(pickupCoords, destinationCoords) {
            // Convertir les coordonnées
            const pickup = L.latLng(pickupCoords.lat, pickupCoords.lng);
            const destination = L.latLng(destinationCoords.lat, destinationCoords.lng);
            
            // Supprimer l'ancien itinéraire s'il existe
            if (routingControl) {
                map.removeControl(routingControl);
            }
            
            // Ajouter le nouvel itinéraire
            routingControl = L.Routing.control({
                waypoints: [
                    pickup,
                    destination
                ],
                routeWhileDragging: false,
                showAlternatives: false,
                fitSelectedRoutes: true,
                lineOptions: {
                    styles: [
                        { color: '#ffcc00', opacity: 0.8, weight: 6 },
                        { color: '#222', opacity: 0.3, weight: 9 }
                    ]
                },
                createMarker: function(i, waypoint, n) {
                    const icon = L.divIcon({
                        html: i === 0 
                            ? '<i class="fas fa-map-marker-alt" style="color:#e74c3c;font-size:24px;"></i>' 
                            : '<i class="fas fa-flag-checkered" style="color:#2ecc71;font-size:24px;"></i>',
                        className: '',
                        iconSize: [24, 24],
                        iconAnchor: [12, 24]
                    });
                    
                    return L.marker(waypoint.latLng, {
                        draggable: false,
                        icon: icon
                    });
                }
            }).addTo(map);
        }
        
        // Mettre à jour le statut de la commande
        function updateOrderStatus(newStatus) {
            if (!currentOrderId) return;
            
            database.ref('orders/' + currentOrderId).update({
                status: newStatus,
                statusUpdatedAt: firebase.database.ServerValue.TIMESTAMP
            })
            .then(() => {
                if (newStatus === 'completed' || newStatus === 'cancelled') {
                    // Réinitialiser l'interface pour une nouvelle commande
                    resetOrderInterface();
                    
                    // Mettre à jour le statut du chauffeur
                    database.ref('drivers/' + driverId).update({
                        status: 'available',
                        currentOrder: null
                    });
                    
                    // Si la commande est terminée, demander une évaluation
                    if (newStatus === 'completed') {
                        alert('Course terminée avec succès! Merci pour votre service.');
                    }
                }
            })
            .catch((error) => {
                console.error('Erreur lors de la mise à jour du statut:', error);
                alert('Une erreur est survenue lors de la mise à jour du statut. Veuillez réessayer.');
            });
        }
        
        // Réinitialiser l'interface après une commande
        function resetOrderInterface() {
            // Cacher la commande en cours
            document.getElementById('currentOrderContainer').style.display = 'none';
            
            // Réinitialiser la variable de commande en cours
            currentOrderId = null;
            
            // Supprimer l'itinéraire de la carte
            if (map && routingControl) {
                map.removeControl(routingControl);
                routingControl = null;
            }
            
            // Recentrer la carte sur la position actuelle
            if (map && currentPosition) {
                map.setView(currentPosition, 15);
            }
        }
        
        // Événements lors du chargement de la page
        document.addEventListener('DOMContentLoaded', function() {
            // Vérifier si le chauffeur est déjà inscrit
            const isRegistered = checkDriverRegistration();
            
            // Écouteur d'événement pour le formulaire d'inscription
            document.getElementById('registerDriverBtn').addEventListener('click', registerDriver);
            
            // Écouteurs d'événements pour les boutons de statut de la commande
            document.getElementById('arrivedBtn').addEventListener('click', () => updateOrderStatus('driver_arrived'));
            document.getElementById('startedBtn').addEventListener('click', () => updateOrderStatus('in_progress'));
            document.getElementById('completedBtn').addEventListener('click', () => updateOrderStatus('completed'));
            document.getElementById('cancelBtn').addEventListener('click', () => {
                if (confirm('Êtes-vous sûr de vouloir annuler cette course?')) {
                    updateOrderStatus('cancelled');
                }
            });
        });
    </script>
</body>
</html>