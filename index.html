<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TAXI MOTO JACQUEVILLE - Commandez votre taxi moto</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    <!-- Leaflet Routing Machine CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet-routing-machine/3.2.12/leaflet-routing-machine.css" />
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            font-size: 16px;
        }
        
        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 15px;
        }
        
        header {
            background-color: #ffcc00;
            color: #222;
            padding: 12px 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            font-size: 18px;
            font-weight: bold;
            display: flex;
            align-items: center;
        }
        
        .logo i {
            margin-right: 8px;
            font-size: 20px;
        }
        
        .hamburger {
            display: none;
            font-size: 24px;
            cursor: pointer;
        }
        
        nav ul {
            display: flex;
            list-style: none;
        }
        
        nav ul li {
            margin-left: 15px;
        }
        
        nav ul li a {
            color: #222;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s;
            font-size: 14px;
        }
        
        nav ul li a:hover {
            color: #555;
        }
        
        .hero {
            background-color: #ffcc00;
            padding: 30px 0;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .hero h1 {
            font-size: 24px;
            margin-bottom: 15px;
            color: #222;
        }
        
        .hero p {
            font-size: 16px;
            margin-bottom: 20px;
            color: #444;
        }
        
        .booking-form {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .booking-form h2 {
            font-size: 20px;
            margin-bottom: 15px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #444;
            font-size: 14px;
        }
        
        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        #map {
            height: 250px;
            width: 100%;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        
        .journey-details {
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
            display: none;
        }
        
        .journey-details h3 {
            margin-bottom: 10px;
            color: #333;
            font-size: 16px;
        }
        
        .detail-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid #eee;
            font-size: 14px;
        }
        
        .detail-row:last-child {
            border-bottom: none;
        }
        
        .detail-label {
            font-weight: 500;
            color: #555;
        }
        
        .detail-value {
            color: #333;
            font-weight: bold;
        }
        
        .btn {
            background-color: #ffcc00;
            color: #222;
            border: none;
            padding: 12px 20px;
            font-size: 16px;
            font-weight: 600;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .btn:hover {
            background-color: #f0c000;
        }
        
        .btn-block {
            display: block;
            width: 100%;
        }
        
        .features {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .feature {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        
        .feature i {
            font-size: 30px;
            color: #ffcc00;
            margin-bottom: 10px;
        }
        
        .feature h3 {
            margin-bottom: 8px;
            color: #333;
            font-size: 18px;
        }
        
        .feature p {
            color: #666;
            line-height: 1.4;
            font-size: 14px;
        }
        
        footer {
            background-color: #222;
            color: white;
            padding: 25px 0 15px;
            text-align: center;
        }
        
        .footer-content {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .footer-section {
            text-align: center;
            margin-bottom: 10px;
        }
        
        .footer-section h3 {
            margin-bottom: 10px;
            color: #ffcc00;
            font-size: 16px;
        }
        
        .footer-section p, .footer-section a {
            color: #ddd;
            margin-bottom: 8px;
            display: block;
            text-decoration: none;
            transition: color 0.3s;
            font-size: 14px;
        }
        
        .footer-section a:hover {
            color: #ffcc00;
        }
        
        .copyright {
            padding-top: 15px;
            border-top: 1px solid #444;
            color: #aaa;
            font-size: 12px;
        }
        
        #confirmOrderBtn {
            display: none;
        }
        
        #loadingIndicator {
            display: none;
            text-align: center;
            margin: 15px 0;
        }
        
        .spinner {
            border: 4px solid rgba(255, 204, 0, 0.3);
            border-radius: 50%;
            border-top: 4px solid #ffcc00;
            width: 25px;
            height: 25px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            overflow: auto;
        }
        
        .modal-content {
            background-color: white;
            margin: 20% auto 0;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 400px;
            text-align: center;
        }
        
        .modal h2 {
            margin-bottom: 15px;
            color: #333;
            font-size: 20px;
        }
        
        .modal p {
            margin-bottom: 20px;
            color: #555;
            line-height: 1.4;
            font-size: 14px;
        }
        
        .btn-group {
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .btn-secondary {
            background-color: #ddd;
            color: #333;
        }
        
        .btn-secondary:hover {
            background-color: #ccc;
        }
        
        .location-permission {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            z-index: 2000;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .permission-content {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            width: 90%;
            max-width: 350px;
        }
        
        .permission-content h2 {
            margin-bottom: 15px;
            color: #333;
            font-size: 20px;
        }
        
        .permission-content p {
            margin-bottom: 20px;
            color: #555;
            line-height: 1.4;
            font-size: 14px;
        }
        
        #locationSearchBtn {
            margin-bottom: 15px;
        }
        
        .address-results {
            max-height: 150px;
            overflow-y: auto;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            display: none;
        }
        
        .address-item {
            padding: 8px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            font-size: 13px;
        }
        
        .address-item:hover {
            background-color: #f5f5f5;
        }
        
        .other-services {
            padding: 30px 0;
            background-color: #f9f9f9;
        }
        
        .section-title {
            text-align: center;
            margin-bottom: 20px;
            color: #333;
            font-size: 22px;
        }
        
        .services-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
        }
        
        .service-card {
            width: 100%;
            max-width: 350px;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .service-image {
            height: 180px;
            background-size: cover;
            background-position: center;
            position: relative;
        }
        
        .service-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
            padding: 20px 15px;
            color: white;
            text-align: center;
        }
        
        .service-overlay h3 {
            font-size: 18px;
            margin-bottom: 8px;
        }
        
        .service-overlay p {
            margin-bottom: 12px;
            font-size: 14px;
        }
        
        .service-btn {
            display: inline-block;
            padding: 8px 18px;
            background-color: #ffcc00;
            color: #222;
            border-radius: 5px;
            text-decoration: none;
            font-weight: 600;
            transition: background-color 0.3s;
            font-size: 14px;
        }
        
        .service-btn:hover {
            background-color: #f0c000;
        }

        /* Notification de chauffeur */
        #driverAssignedModal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            overflow: auto;
        }
        
        .driver-info {
            margin-top: 15px;
            padding: 15px;
            background-color: #f5f5f5;
            border-radius: 5px;
        }
        
        .driver-info p {
            margin-bottom: 10px;
            font-size: 15px;
        }
        
        .driver-info p strong {
            font-weight: bold;
            color: #333;
        }
        
        /* Formulaire d'inscription */
        #registrationModal {
            display: flex;
            position: fixed;
            z-index: 3000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
            justify-content: center;
            align-items: center;
        }
        
        .registration-form {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 450px;
        }
        
        .registration-form h2 {
            margin-bottom: 20px;
            text-align: center;
            color: #333;
        }
        
        .welcome-message {
            display: none;
            background-color: #e9f7ef;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            border-left: 4px solid #2ecc71;
        }
        
        .welcome-message p {
            margin: 0;
            color: #27ae60;
        }
        
        .profile-info {
            display: flex;
            align-items: center;
            margin-left: auto;
        }
        
        .profile-info span {
            margin-right: 10px;
            font-size: 14px;
            font-weight: 500;
        }
        
        /* Styles responsive */
        @media (min-width: 768px) {
            .logo {
                font-size: 24px;
            }
            
            .logo i {
                font-size: 28px;
            }
            
            .hero h1 {
                font-size: 36px;
            }
            
            .hero p {
                font-size: 18px;
            }
            
            #map {
                height: 400px;
            }
            
            .features {
                flex-direction: row;
                justify-content: space-between;
            }
            
            .feature {
                width: 32%;
            }
            
            .footer-content {
                flex-direction: row;
                justify-content: space-between;
            }
            
            .footer-section {
                text-align: left;
                width: 30%;
            }
            
            nav ul li a {
                font-size: 16px;
            }
            
            .modal-content {
                margin: 15% auto 0;
            }
        }
        
        @media (max-width: 767px) {
            .hamburger {
                display: block;
            }
            
            nav {
                position: fixed;
                top: 50px;
                left: -100%;
                width: 80%;
                height: 100vh;
                background-color: #fff;
                box-shadow: 2px 0 5px rgba(0,0,0,0.1);
                transition: left 0.3s ease;
                z-index: 1000;
            }
            
            nav.active {
                left: 0;
            }
            
            nav ul {
                flex-direction: column;
                padding: 20px;
            }
            
            nav ul li {
                margin: 0 0 15px 0;
                width: 100%;
            }
            
            nav ul li a {
                display: block;
                padding: 8px 0;
                font-size: 16px;
            }
            
            .overlay {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0,0,0,0.5);
                z-index: 999;
            }
            
            .overlay.active {
                display: block;
            }
        }
    </style>
</head>
<body>
    <!-- Modal d'inscription -->
    <div id="registrationModal" class="modal">
        <div class="registration-form">
            <h2>Bienvenue chez TAXI MOTO JACQUEVILLE</h2>
            <p>Pour utiliser notre service, veuillez vous inscrire :</p>
            
            <div class="form-group">
                <label for="regFirstName">Prénom</label>
                <input type="text" id="regFirstName" placeholder="Votre prénom" required>
            </div>
            
            <div class="form-group">
                <label for="regLastName">Nom</label>
                <input type="text" id="regLastName" placeholder="Votre nom" required>
            </div>
            
            <div class="form-group">
                <label for="regPhone">Numéro de téléphone</label>
                <input type="tel" id="regPhone" placeholder="Exemple: 07XXXXXXXX" required>
            </div>
            
            <button class="btn btn-block" id="registerBtn">S'inscrire</button>
        </div>
    </div>
    
    <div id="locationPermission" class="location-permission">
        <div class="permission-content">
            <h2>Autorisation de localisation</h2>
            <p>Pour utiliser notre service de taxi moto, nous avons besoin d'accéder à votre position actuelle.</p>
            <p>Cela nous permettra de vous proposer un itinéraire précis et d'envoyer un chauffeur à votre emplacement exact.</p>
            <button class="btn" id="allowLocationBtn">Autoriser l'accès</button>
        </div>
    </div>
    
    <div class="overlay" id="navOverlay"></div>
    
    <header>
        <div class="container header-content">
            <div class="logo">
                <i class="fas fa-motorcycle"></i> TAXI MOTO JACQUEVILLE
            </div>
            <div class="profile-info">
                <span id="userNameDisplay"></span>
            </div>
            <div class="hamburger" id="hamburger">
                <i class="fas fa-bars"></i>
            </div>
            <nav id="mobileNav">
                <ul>
                    <li><a href="#" class="active">Accueil</a></li>
                    <li><a href="apros.html">À propos</a></li>
                    <li><a href="contact.html">Contact</a></li>
                </ul>
            </nav>
        </div>
    </header>
    
    <section class="hero">
        <div class="container">
            <div class="welcome-message" id="welcomeMessage">
                <p>Bienvenue <span id="welcomeUserName"></span> !</p>
            </div>
            <h1>Commandez votre taxi moto en quelques clics</h1>
            <p>Rapide, fiable et économique - Nous vous conduisons à destination en toute sécurité</p>
        </div>
    </section>
    
    <main class="container">
        <div class="booking-form">
            <h2>Réservez votre course</h2>
            <div class="form-group">
                <label for="pickup">Point de départ</label>
                <input type="text" id="pickup" placeholder="Votre position actuelle se chargera automatiquement...">
                <div id="pickupResults" class="address-results"></div>
            </div>
            
            <div class="form-group">
                <label for="destination">Destination</label>
                <input type="text" id="destination" placeholder="Où souhaitez-vous aller ?">
                <div id="destinationResults" class="address-results"></div>
            </div>
            
            <div id="map"></div>
            
            <div id="loadingIndicator">
                <div class="spinner"></div>
                <p>Calcul de l'itinéraire en cours...</p>
            </div>
            
            <div class="journey-details" id="journeyDetails">
                <h3>Détails de la course</h3>
                <div class="detail-row">
                    <span class="detail-label">Distance:</span>
                    <span class="detail-value" id="distance">-- km</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Durée estimée:</span>
                    <span class="detail-value" id="duration">-- min</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Prix:</span>
                    <span class="detail-value" id="price">-- FCFA</span>
                </div>
            </div>
            
            <button class="btn btn-block" id="searchRouteBtn">Rechercher l'itinéraire</button>
            <button class="btn btn-block" id="confirmOrderBtn">Confirmer la commande</button>
        </div>
        
        <div class="features">
            <div class="feature">
                <i class="fas fa-bolt"></i>
                <h3>Rapide</h3>
                <p>Évitez les embouteillages et arrivez à destination rapidement</p>
            </div>
            <div class="feature">
                <i class="fas fa-money-bill-wave"></i>
                <h3>Économique</h3>
                <p>Tarifs compétitifs avec prix fixe à 100 FCFA par km</p>
            </div>
            <div class="feature">
                <i class="fas fa-shield-alt"></i>
                <h3>Sécurisé</h3>
                <p>Chauffeurs professionnels et casques fournis pour votre sécurité</p>
            </div>
        </div>
    </main>
    
    <div id="confirmationModal" class="modal">
        <div class="modal-content">
            <h2>Confirmer votre commande</h2>
            <p>Vous êtes sur le point de commander un taxi moto pour un trajet de <span id="modalDistance">-- km</span> au prix de <span id="modalPrice">-- FCFA</span>.</p>
            <p>Êtes-vous d'accord avec ce prix ?</p>
            <div class="btn-group">
                <button class="btn btn-secondary" id="cancelOrderBtn">Annuler</button>
                <button class="btn" id="finalConfirmBtn">Confirmer</button>
            </div>
        </div>
    </div>

    <!-- Modal pour les informations du chauffeur -->
    <div id="driverAssignedModal" class="modal">
        <div class="modal-content">
            <h2>Un chauffeur a accepté votre course!</h2>
            <div class="driver-info">
                <p><strong>Nom du chauffeur:</strong> <span id="driverName">--</span></p>
                <p><strong>Numéro de téléphone:</strong> <span id="driverPhone">--</span></p>
                <p><strong>Plaque d'immatriculation:</strong> <span id="driverPlate">--</span></p>
            </div>
            <p>Le chauffeur est en route vers votre emplacement.</p>
            <div class="btn-group">
                <button class="btn" id="acknowledgeDriverBtn">J'ai compris</button>
            </div>
        </div>
    </div>

    <section class="other-services">
        <div class="container">
            <h2 class="section-title">Autres services</h2>
            <div class="services-container">
                <div class="service-card">
                    <div class="service-image" style="background-image: url('image/opo.png');">
                        <div class="service-overlay">
                            <h3>Eden Livraison</h3>
                            <p>Service de livraison rapide et fiable</p>
                            <a href="eden.html" class="service-btn">Accéder</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    
    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>À propos de nous</h3>
                    <p>TAXI MOTO EXPRESS est votre partenaire de confiance pour vos déplacements urbains rapides et économiques.</p>
                </div>
                <div class="footer-section">
                    <h3>Liens utiles</h3>
                    <a href="#">Conditions d'utilisation</a>
                    <a href="#">Politique de confidentialité</a>
                    <a href="#">FAQ</a>
                </div>
                <div class="footer-section">
                    <h3>Contact</h3>
                    <p>Email: utilisateurmarcio@gmail.com</p>
                    <p>Téléphone: +2250172369840</p>
                </div>
            </div>
            <div class="copyright">
                <p>&copy; 2025 TAXI MOTO EXPRESS - Tous droits réservés</p>
            </div>
        </div>
    </footer>

    <!-- Leaflet JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <!-- Leaflet Routing Machine -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-routing-machine/3.2.12/leaflet-routing-machine.min.js"></script>

<script>
// Configuration Firebase
const firebaseConfig = {
    apiKey: "AIzaSyBZOjPxnWZ7w9A5MdKulPSsuEcQMzj6u98",
    authDomain: "transport-a8225.firebaseapp.com",
    databaseURL: "https://transport-a8225-default-rtdb.firebaseio.com",
    projectId: "transport-a8225",
    storageBucket: "transport-a8225.firebasestorage.app",
    messagingSenderId: "268859727706",
    appId: "1:268859727706:web:3368b93a20826281799d63",
    measurementId: "G-PE30CHJ409"
};

// Initialiser Firebase
firebase.initializeApp(firebaseConfig);
const database = firebase.database();

// Variables globales
let map;
let routingControl;
let currentPosition;
let currentOrderId = null;
let userInfo = null;
let watchPositionId = null;
let locationMarker = null;
let isGettingLocation = false;
let defaultLocation = { lat: 5.3364, lng: -4.0266 }; // Position par défaut (Abidjan Centre)
let routeData = {
    distance: 0,
    duration: 0,
    price: 0,
    pickup: '',
    destination: '',
    pickupCoords: {},
    destinationCoords: {}
};

// Coordonnées pour centrer la carte sur la Côte d'Ivoire
const ivoryCoastCenter = [7.54, -5.547]; // Centre de la Côte d'Ivoire
const ivoryCoastBounds = [
    [4.193, -8.602], // Sud-Ouest
    [10.736, -2.493]  // Nord-Est
];

// Options de geocodage améliorées pour Nominatim
const geocodeOptions = {
    countryCodes: 'ci', // Code pays pour la Côte d'Ivoire
    viewbox: '4.193,-8.602,10.736,-2.493', // viewbox approximatif de la Côte d'Ivoire
    bounded: 1, // Recherche confinée au viewbox
    addressdetails: 1,
    'accept-language': 'fr'
};

// Base de données de lieux populaires en Côte d'Ivoire
const popularPlaces = [
    { name: "Abidjan Centre", lat: 5.3364, lng: -4.0266 },
    { name: "Yamoussoukro", lat: 6.8276, lng: -5.2893 },
    { name: "Bouaké", lat: 7.6908, lng: -5.0303 },
    { name: "San-Pédro", lat: 4.7492, lng: -6.6367 },
    { name: "Korhogo", lat: 9.4580, lng: -5.6296 },
    { name: "Daloa", lat: 6.8772, lng: -6.4444 },
    { name: "Man", lat: 7.4120, lng: -7.5469 },
    { name: "Gagnoa", lat: 6.1328, lng: -5.9513 },
    { name: "Abengourou", lat: 6.7309, lng: -3.4969 },
    { name: "Grand-Bassam", lat: 5.2121, lng: -3.7501 },
    { name: "Assinie", lat: 5.1453, lng: -3.2994 },
    { name: "Jacqueville", lat: 5.2061, lng: -4.4227 },
    { name: "Dabou", lat: 5.3259, lng: -4.3926 },
    { name: "Bonoua", lat: 5.2747, lng: -3.5966 },
    { name: "Bingerville", lat: 5.3526, lng: -3.8850 },
    { name: "Plateau (Abidjan)", lat: 5.3232, lng: -4.0164 },
    { name: "Cocody (Abidjan)", lat: 5.3601, lng: -3.9673 },
    { name: "Marcory (Abidjan)", lat: 5.3010, lng: -3.9822 },
    { name: "Treichville (Abidjan)", lat: 5.2918, lng: -4.0116 },
    { name: "Port-Bouët (Abidjan)", lat: 5.2569, lng: -3.9295 },
    { name: "Yopougon (Abidjan)", lat: 5.3248, lng: -4.0857 },
    { name: "Adjamé (Abidjan)", lat: 5.3569, lng: -4.0259 },
    { name: "Abobo (Abidjan)", lat: 5.4301, lng: -4.0446 },
    { name: "Koumassi (Abidjan)", lat: 5.2901, lng: -3.9540 }
];

// Éléments du DOM
const registrationModal = document.getElementById('registrationModal');
const regFirstName = document.getElementById('regFirstName');
const regLastName = document.getElementById('regLastName');
const regPhone = document.getElementById('regPhone');
const registerBtn = document.getElementById('registerBtn');
const userNameDisplay = document.getElementById('userNameDisplay');
const welcomeMessage = document.getElementById('welcomeMessage');
const welcomeUserName = document.getElementById('welcomeUserName');
const locationPermission = document.getElementById('locationPermission');
const allowLocationBtn = document.getElementById('allowLocationBtn');
const hamburger = document.getElementById('hamburger');
const navOverlay = document.getElementById('navOverlay');
const mobileNav = document.getElementById('mobileNav');
const pickupInput = document.getElementById('pickup');
const destinationInput = document.getElementById('destination');
const pickupResults = document.getElementById('pickupResults');
const destinationResults = document.getElementById('destinationResults');
const searchRouteBtn = document.getElementById('searchRouteBtn');
const confirmOrderBtn = document.getElementById('confirmOrderBtn');
const journeyDetails = document.getElementById('journeyDetails');
const distanceElement = document.getElementById('distance');
const durationElement = document.getElementById('duration');
const priceElement = document.getElementById('price');
const loadingIndicator = document.getElementById('loadingIndicator');
const confirmationModal = document.getElementById('confirmationModal');
const modalDistance = document.getElementById('modalDistance');
const modalPrice = document.getElementById('modalPrice');
const cancelOrderBtn = document.getElementById('cancelOrderBtn');
const finalConfirmBtn = document.getElementById('finalConfirmBtn');
const driverAssignedModal = document.getElementById('driverAssignedModal');
const driverName = document.getElementById('driverName');
const driverPhone = document.getElementById('driverPhone');
const driverPlate = document.getElementById('driverPlate');
const acknowledgeDriverBtn = document.getElementById('acknowledgeDriverBtn');

/**
 * Gestion de l'utilisateur
 */

// Vérifier si l'utilisateur est déjà inscrit
function checkUserRegistration() {
    const userId = localStorage.getItem('taxiMotoUserId');
    if (userId) {
        // Afficher un indicateur de chargement discret si nécessaire
        database.ref('users/' + userId).once('value')
            .then((snapshot) => {
                if (snapshot.exists()) {
                    userInfo = snapshot.val();
                    hideRegistrationModal();
                    displayUserInfo();
                    // Initialiser la carte et commencer immédiatement la géolocalisation
                    initMapAndLocation();
                } else {
                    showRegistrationModal();
                }
            })
            .catch(() => {
                // En cas d'erreur de connexion, on vérifie s'il y a des données en cache
                const cachedUserInfo = localStorage.getItem('taxiMotoUserInfo');
                if (cachedUserInfo) {
                    try {
                        userInfo = JSON.parse(cachedUserInfo);
                        hideRegistrationModal();
                        displayUserInfo();
                        initMapAndLocation();
                    } catch (e) {
                        showRegistrationModal();
                    }
                } else {
                    showRegistrationModal();
                }
            });
    } else {
        showRegistrationModal();
    }
}

// Initialisation combinée de la carte et de la localisation
function initMapAndLocation() {
    // Initialiser la carte immédiatement
    initMap();
    
    // Essayer d'obtenir la position actuelle immédiatement
    // sans demander de permission préalable via modal
    setTimeout(() => {
        obtainCurrentPosition(true);
    }, 500);
}

// Afficher le modal d'inscription
function showRegistrationModal() {
    registrationModal.style.display = 'flex';
}

// Cacher le modal d'inscription
function hideRegistrationModal() {
    registrationModal.style.display = 'none';
}

// Afficher les informations de l'utilisateur
function displayUserInfo() {
    if (userInfo) {
        userNameDisplay.textContent = userInfo.firstName;
        welcomeUserName.textContent = userInfo.firstName;
        welcomeMessage.style.display = 'block';
    }
}

// Gérer l'inscription de l'utilisateur
registerBtn.addEventListener('click', () => {
    const firstName = regFirstName.value.trim();
    const lastName = regLastName.value.trim();
    const phone = regPhone.value.trim();
    
    if (!firstName || !lastName || !phone) {
        alert('Veuillez remplir tous les champs');
        return;
    }
    
    if (!validatePhoneNumber(phone)) {
        alert('Veuillez entrer un numéro de téléphone valide (format: 07XXXXXXXX)');
        return;
    }
    
    registerBtn.disabled = true;
    registerBtn.textContent = 'Inscription en cours...';
    
    // Créer un nouvel utilisateur
    const newUserRef = database.ref('users').push();
    const userData = {
        firstName: firstName,
        lastName: lastName,
        phone: phone,
        createdAt: firebase.database.ServerValue.TIMESTAMP
    };
    
    newUserRef.set(userData)
        .then(() => {
            const userId = newUserRef.key;
            localStorage.setItem('taxiMotoUserId', userId);
            // Stocker également en cache pour utilisation hors ligne
            localStorage.setItem('taxiMotoUserInfo', JSON.stringify(userData));
            userInfo = userData;
            hideRegistrationModal();
            displayUserInfo();
            initMapAndLocation();
        })
        .catch(() => {
            registerBtn.disabled = false;
            registerBtn.textContent = 'S\'inscrire';
            alert('Une erreur est survenue. Veuillez réessayer.');
        });
});

// Valider le format du numéro de téléphone (format ivoirien)
function validatePhoneNumber(phone) {
    // Format ivoirien: 01-99 XX XX XX XX (10 chiffres commençant par 0)
    const regex = /^0[1-9][0-9]{8}$/;
    return regex.test(phone);
}

/**
 * Gestion de la localisation
 */

// Afficher le modal de permission de localisation (uniquement si nécessaire)
function showLocationPermission() {
    locationPermission.style.display = 'flex';
}

// Gérer l'autorisation de localisation
allowLocationBtn.addEventListener('click', () => {
    locationPermission.style.display = 'none';
    obtainCurrentPosition(true);
});

// Initialiser la carte Leaflet avec centre sur la Côte d'Ivoire
function initMap() {
    try {
        // Créer la carte centrée sur la Côte d'Ivoire
        map = L.map('map', {
            zoomControl: true,
            maxBoundsViscosity: 1.0
        }).setView(ivoryCoastCenter, 7); // Vue plus large pour montrer la Côte d'Ivoire
        
        // Éviter le zoom trop faible ou trop fort
        map.setMinZoom(6);  // Zoom minimum pour voir toute la Côte d'Ivoire
        map.setMaxZoom(18); // Zoom maximum pour les détails
        map.setMaxBounds(L.latLngBounds(
            L.latLng(3.0, -9.5),  // Sud-Ouest étendu
            L.latLng(12.0, -1.5)  // Nord-Est étendu
        ));
        
        // Ajouter la couche de carte OpenStreetMap
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);
        
        // Ajouter une icône "Recentrer" sur la carte
        const recenterControl = L.control({ position: 'bottomright' });
        recenterControl.onAdd = function() {
            const div = L.DomUtil.create('div', 'recenter-control');
            div.innerHTML = '<button title="Recentrer sur ma position" style="padding: 8px; background: white; border: 1px solid #ccc; border-radius: 4px; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.2);"><i class="fas fa-location-arrow"></i></button>';
            div.onclick = function() {
                if (currentPosition) {
                    map.setView([currentPosition.lat, currentPosition.lng], 15);
                } else {
                    // Si pas de position actuelle, essayer à nouveau
                    obtainCurrentPosition(true);
                }
            };
            return div;
        };
        recenterControl.addTo(map);
        
        // Ajouter un bouton pour zoomer sur toute la Côte d'Ivoire
        const countryViewControl = L.control({ position: 'bottomright' });
        countryViewControl.onAdd = function() {
            const div = L.DomUtil.create('div', 'country-view-control');
            div.innerHTML = '<button title="Voir toute la Côte d\'Ivoire" style="padding: 8px; background: white; border: 1px solid #ccc; border-radius: 4px; cursor: pointer; margin-top: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.2);"><i class="fas fa-globe-africa"></i></button>';
            div.onclick = function() {
                map.fitBounds(ivoryCoastBounds);
            };
            return div;
        };
        countryViewControl.addTo(map);
        
    } catch (error) {
        console.error("Erreur d'initialisation de la carte:", error);
        // Ne pas montrer d'erreur à l'utilisateur, mais plutôt initialiser une carte par défaut
        setTimeout(() => {
            try {
                if (!map) {
                    map = L.map('map').setView(defaultLocation, 13);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
                }
            } catch (e) {
                console.warn("Échec de la création de la carte de secours:", e);
            }
        }, 1000);
    }
}

// Obtenir la position actuelle avec système amélioré pour mobile
function obtainCurrentPosition(recenter = false, silent = false) {
    if (isGettingLocation) return;
    isGettingLocation = true;
    
    if (pickupInput && !silent) {
        pickupInput.placeholder = "Recherche de votre position...";
    }
    
    // Définir le timeout pour la géolocalisation
    let positionTimeout = setTimeout(() => {
        handlePositionError({
            code: 3,
            message: "Délai d'attente dépassé"
        });
    }, 8000);
    
    // Fonction de succès de localisation
    function handlePositionSuccess(position) {
        clearTimeout(positionTimeout);
        isGettingLocation = false;
        
        if (watchPositionId) {
            navigator.geolocation.clearWatch(watchPositionId);
            watchPositionId = null;
        }
        
        // Enregistrer la position actuelle
        currentPosition = {
            lat: position.coords.latitude,
            lng: position.coords.longitude,
            accuracy: position.coords.accuracy || 100
        };
        
        // Vérifier si la position est en Côte d'Ivoire (avec une marge d'erreur)
        const isInIvoryCoast = checkIfInIvoryCoast(currentPosition);
        
        if (!isInIvoryCoast) {
            // Si hors de la Côte d'Ivoire, utiliser la position par défaut
            console.warn("Position en dehors de la Côte d'Ivoire, utilisation de la position par défaut");
            currentPosition = { ...defaultLocation };
            
            // Afficher un message seulement si le paramètre silent est false
            if (!silent) {
                showTemporaryMessage("Position détectée en dehors de la Côte d'Ivoire. Utilisation d'une position par défaut.", 3000);
            }
        }
        
        // Mise à jour du marqueur de position
        if (map) {
            updatePositionMarker();
            
            // Si demandé, centrer la carte sur la position
            if (recenter) {
                map.setView([currentPosition.lat, currentPosition.lng], 15);
            }
        }
        
        // Géocoder la position actuelle et définir le point de départ automatiquement
        reverseGeocode(currentPosition, (address) => {
            if (address) {
                if (pickupInput) {
                    pickupInput.value = address;
                    routeData.pickup = address;
                    routeData.pickupCoords = { ...currentPosition };
                }
            }
        });
    }
    
    // Fonction d'erreur de localisation
    function handlePositionError(error) {
        console.warn("Erreur de géolocalisation:", error.message);
        clearTimeout(positionTimeout);
        isGettingLocation = false;
        
        if (watchPositionId) {
            navigator.geolocation.clearWatch(watchPositionId);
            watchPositionId = null;
        }
        
        // Utiliser le service d'IP-géolocalisation comme solution de secours
        fetchLocationByIP()
            .then(ipLocation => {
                if (ipLocation && ipLocation.latitude && ipLocation.longitude) {
                    // Vérifier si la position IP est en Côte d'Ivoire
                    const ipPos = {
                        lat: ipLocation.latitude,
                        lng: ipLocation.longitude
                    };
                    
                    if (checkIfInIvoryCoast(ipPos)) {
                        currentPosition = ipPos;
                        console.log("Position obtenue via IP:", currentPosition);
                    } else {
                        currentPosition = { ...defaultLocation };
                        console.log("Position IP hors de Côte d'Ivoire, utilisation de la position par défaut");
                    }
                } else {
                    currentPosition = { ...defaultLocation };
                    console.log("Impossible d'obtenir la position par IP, utilisation de la position par défaut");
                }
                
                if (map) {
                    updatePositionMarker();
                    if (recenter) {
                        map.setView([currentPosition.lat, currentPosition.lng], 15);
                    }
                }
                
                // Géocoder la position
                reverseGeocode(currentPosition, (address) => {
                    if (pickupInput) {
                        pickupInput.value = address || "Position actuelle";
                        routeData.pickup = address || "Position actuelle";
                        routeData.pickupCoords = { ...currentPosition };
                    }
                });
                
                if (!silent) {
                    if (currentPosition.lat === defaultLocation.lat && currentPosition.lng === defaultLocation.lng) {
                        showTemporaryMessage("Impossible d'accéder à votre position. Utilisation d'une position par défaut.", 3500);
                    } else {
                        showTemporaryMessage("Position approximative détectée.", 2000);
                    }
                }
            })
            .catch(e => {
                console.warn("Erreur lors de la géolocalisation par IP:", e);
                currentPosition = { ...defaultLocation };
                
                if (map) {
                    updatePositionMarker();
                    if (recenter) {
                        map.setView([currentPosition.lat, currentPosition.lng], 15);
                    }
                }
                
                reverseGeocode(currentPosition, (address) => {
                    if (pickupInput) {
                        pickupInput.value = address || "Position par défaut";
                        routeData.pickup = address || "Position par défaut";
                        routeData.pickupCoords = { ...currentPosition };
                    }
                });
                
                if (!silent) {
                    showTemporaryMessage("Impossible d'accéder à votre position. Utilisation d'une position par défaut.", 3500);
                }
            });
    }
    
    // Vérifier si la géolocalisation est disponible
    if ('geolocation' in navigator) {
        try {
            // Régler les options de géolocalisation pour mobile
            const geoOptions = {
                enableHighAccuracy: true,
                timeout: 7000,
                maximumAge: 0
            };
            
            // Demander la permission et obtenir la position
            navigator.geolocation.getCurrentPosition(
                handlePositionSuccess,
                handlePositionError,
                geoOptions
            );
        } catch (e) {
            console.error("Exception lors de la demande de géolocalisation:", e);
            handlePositionError({
                code: 0,
                message: "Exception: " + e.message
            });
        }
    } else {
        console.warn("La géolocalisation n'est pas prise en charge par ce navigateur");
        handlePositionError({
            code: 0,
            message: "Géolocalisation non supportée"
        });
    }
}

// Vérifier si les coordonnées sont dans les limites de la Côte d'Ivoire
function checkIfInIvoryCoast(position) {
    // Ajouter une petite marge pour tenir compte des erreurs de géolocalisation
    const bounds = {
        minLat: ivoryCoastBounds[0][0] - 0.5, // 0.5 degrés de marge
        maxLat: ivoryCoastBounds[1][0] + 0.5,
        minLng: ivoryCoastBounds[0][1] - 0.5,
        maxLng: ivoryCoastBounds[1][1] + 0.5
    };
    
    return position.lat >= bounds.minLat && position.lat <= bounds.maxLat &&
           position.lng >= bounds.minLng && position.lng <= bounds.maxLng;
}

// Obtenir la position par adresse IP (fallback si la géolocalisation échoue)
function fetchLocationByIP() {
    return new Promise((resolve, reject) => {
        // Utiliser un service de géolocalisation par IP
        fetch('https://ipapi.co/json/')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Erreur HTTP: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                resolve(data);
            })
            .catch(error => {
                console.warn("Erreur lors de la géolocalisation par IP:", error);
                
                // Essayer un autre service comme fallback
                fetch('https://ipinfo.io/json')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`Erreur HTTP: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        // Convertir "lat,lng" en objet
                        if (data.loc) {
                            const [latitude, longitude] = data.loc.split(',').map(parseFloat);
                            resolve({
                                latitude,
                                longitude,
                                country: data.country
                            });
                        } else {
                            reject(new Error("Données de géolocalisation incomplètes"));
                        }
                    })
                    .catch(err => {
                        reject(err);
                    });
            });
    });
}

// Mettre à jour le marqueur de position sur la carte
function updatePositionMarker() {
    if (!map || !currentPosition) return;
    
    // Si un marqueur existe déjà, le mettre à jour
    if (locationMarker) {
        locationMarker.setLatLng([currentPosition.lat, currentPosition.lng]);
        if (locationMarker.accuracyCircle) {
            locationMarker.accuracyCircle.setLatLng([currentPosition.lat, currentPosition.lng]);
            locationMarker.accuracyCircle.setRadius(currentPosition.accuracy || 100);
        }
    } else {
        // Sinon créer un nouveau marqueur avec une icône personnalisée
        const locationIcon = L.divIcon({
            html: '<div style="background-color: #4285F4; width: 16px; height: 16px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 3px rgba(0,0,0,0.4);"></div>',
            className: 'location-marker-icon',
            iconSize: [22, 22],
            iconAnchor: [11, 11]
        });
        
        locationMarker = L.marker([currentPosition.lat, currentPosition.lng], {
            icon: locationIcon,
            zIndexOffset: 1000
        }).addTo(map);
        
        // Créer un cercle de précision autour du marqueur
        const accuracyCircle = L.circle([currentPosition.lat, currentPosition.lng], {
            radius: currentPosition.accuracy || 100,
            fillColor: '#4285F4',
            fillOpacity: 0.15,
            stroke: false
        }).addTo(map);
        
        // Associer le cercle au marqueur pour les mises à jour
        locationMarker.accuracyCircle = accuracyCircle;
    }
}

// Fonction de géocodage inversé améliorée (coordonnées -> adresse) avec système multi-sources
function reverseGeocode(coords, callback) {
    if (!coords || !coords.lat || !coords.lng) {
        callback(null);
        return;
    }
    
    // Vérifier d'abord si c'est un lieu populaire
    const popularPlace = findNearestPopularPlace(coords, 0.5); // 0.5 km de rayon
    if (popularPlace) {
        callback(popularPlace.name);
        return;
    }
    
    // Si ce n'est pas un lieu populaire connu, utiliser le service de géocodage
    const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${coords.lat}&lon=${coords.lng}&zoom=18&addressdetails=1&accept-language=fr`;
    
    // Utiliser un timeout pour éviter les attentes trop longues
    const timeoutPromise = new Promise((_, reject) => {
        setTimeout(() => reject(new Error('Timeout')), 5000);
    });
    
    Promise.race([
        fetch(url, { 
            headers: { 'User-Agent': 'TaxiMotoJacqueville/1.0' } 
        }).then(response => response.json()),
        timeoutPromise
    ])
    .then(data => {
        // Formater l'adresse de manière plus lisible et concise
        let formattedAddress;
        if (data && data.display_name) {
            // Essayer d'extraire les composantes importantes de l'adresse
            const addr = data.address || {};
            const components = [];
            
            // Construire l'adresse dans un format plus humain
            if (addr.road) components.push(addr.road);
            if (addr.neighbourhood) components.push(addr.neighbourhood);
            if (addr.suburb) components.push(addr.suburb);
            if (addr.town || addr.city) components.push(addr.town || addr.city);
            
            formattedAddress = components.length > 0 ? 
                components.join(', ') : 
                data.display_name.split(',').slice(0, 3).join(',');
        }
        
        callback(formattedAddress || "Position actuelle");
    })
    .catch(error => {
        console.warn('Erreur lors du géocodage inversé:', error);
        // En cas d'erreur, essayer de trouver un lieu populaire à proximité comme solution de secours
        const nearestPopularPlace = findNearestPopularPlace(coords, 5); // Elargir le rayon à 5km
        if (nearestPopularPlace) {
            callback(`Près de ${nearestPopularPlace.name}`);
        } else {
            callback("Position actuelle");
        }
    });
}

// Trouver le lieu populaire le plus proche dans un rayon donné (en km)
function findNearestPopularPlace(coords, maxDistance) {
    let nearestPlace = null;
    let minDistance = Infinity;
    
    for (const place of popularPlaces) {
        const distance = calculateHaversineDistance(
            coords.lat, coords.lng, 
            place.lat, place.lng
        );
        
        if (distance < maxDistance && distance < minDistance) {
            minDistance = distance;
            nearestPlace = place;
        }
    }
    
    return nearestPlace;
}

// Fonction de géocodage améliorée (adresse -> coordonnées) avec support des lieux locaux
function geocode(address, callback) {
    if (!address || address.trim() === '') {
        callback([]);
        return;
    }
    
    // Rechercher d'abord dans notre base de données de lieux populaires
    const matchingPlaces = popularPlaces.filter(place => 
        place.name.toLowerCase().includes(address.toLowerCase())
    );
    
    // Si nous avons des correspondances dans nos lieux populaires, les utiliser
    if (matchingPlaces.length > 0) {
        const results = matchingPlaces.map(place => ({
           display_name: place.name,
            lat: place.lat,
            lon: place.lng,
            importance: 0.9,
            type: "popular",
            address: {
                city: place.name.includes("Abidjan") ? "Abidjan" : "",
                road: ""
            }
        }));
        
        callback(results);
        return;
    }
    
    // Si pas de correspondance dans les lieux populaires, utiliser le service de géocodage
    const encodedAddress = encodeURIComponent(address);
    const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodedAddress}&limit=5&countrycodes=ci&viewbox=-8.602,4.193,-2.493,10.736&bounded=1&accept-language=fr`;
    
    fetch(url, { 
        headers: { 'User-Agent': 'TaxiMotoJacqueville/1.0' } 
    })
    .then(response => response.json())
    .then(data => {
        // Filtrer les résultats pour n'avoir que ceux en Côte d'Ivoire
        const filteredResults = data.filter(result => {
            const lat = parseFloat(result.lat);
            const lon = parseFloat(result.lon);
            
            return checkIfInIvoryCoast({
                lat: lat,
                lng: lon
            });
        });
        
        callback(filteredResults);
    })
    .catch(error => {
        console.warn('Erreur lors du géocodage:', error);
        callback([]);
    });
}

/**
 * Utilitaires de distance et de prix
 */

// Calculer la distance entre deux points avec la formule de Haversine
function calculateHaversineDistance(lat1, lon1, lat2, lon2) {
    const R = 6371; // Rayon de la Terre en km
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a = 
        Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
        Math.sin(dLon/2) * Math.sin(dLon/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    const distance = R * c; // Distance en km
    
    return distance;
}

// Calculer le prix estimé pour une distance donnée
function calculatePrice(distance) {
    // Base de prix pour les trajets courts
    const basePrice = 500; // FCFA
    const pricePerKm = 300; // FCFA par kilomètre
    const minPrice = 500; // Prix minimum
    
    // Calcul avec des règles de tarification dégressives pour les longues distances
    let price;
    if (distance <= 1) {
        // Moins d'1km: prix de base
        price = basePrice;
    } else if (distance <= 5) {
        // Entre 1 et 5 km: prix de base + tarif au km
        price = basePrice + pricePerKm * (distance - 1);
    } else if (distance <= 10) {
        // Entre 5 et 10 km: dégressif
        price = basePrice + pricePerKm * 4 + pricePerKm * 0.9 * (distance - 5);
    } else {
        // Plus de 10 km: encore plus dégressif
        price = basePrice + pricePerKm * 4 + pricePerKm * 0.9 * 5 + pricePerKm * 0.8 * (distance - 10);
    }
    
    // Arrondir au 100 FCFA supérieur
    price = Math.ceil(price / 100) * 100;
    
    // Assurer un prix minimum
    return Math.max(price, minPrice);
}

// Convertir les minutes en texte lisible
function formatDuration(minutes) {
    if (minutes < 1) {
        return "moins d'une minute";
    } else if (minutes === 1) {
        return "1 minute";
    } else if (minutes < 60) {
        return `${Math.round(minutes)} minutes`;
    } else {
        const hours = Math.floor(minutes / 60);
        const remainingMinutes = Math.round(minutes % 60);
        
        if (remainingMinutes === 0) {
            return hours === 1 ? "1 heure" : `${hours} heures`;
        } else {
            return `${hours} heure${hours > 1 ? 's' : ''} ${remainingMinutes} minute${remainingMinutes > 1 ? 's' : ''}`;
        }
    }
}

/**
 * Gestion de l'itinéraire
 */

// Calculer l'itinéraire entre deux points
function calculateRoute(from, to) {
    if (!map) return;
    
    // Afficher l'indicateur de chargement
    loadingIndicator.style.display = 'flex';
    
    // Si un itinéraire existe déjà, le supprimer
    if (routingControl) {
        map.removeControl(routingControl);
        routingControl = null;
    }
    
    // Créer un nouvel itinéraire
    routingControl = L.Routing.control({
        waypoints: [
            L.latLng(from.lat, from.lng),
            L.latLng(to.lat, to.lng)
        ],
        router: L.Routing.osrmv1({
            serviceUrl: 'https://router.project-osrm.org/route/v1',
            profile: 'driving', // Utiliser le profil 'driving' qui est plus adapté aux motos
            useHints: false // Désactiver les suggestions pour éviter les problèmes
        }),
        lineOptions: {
            styles: [
                {color: '#3388ff', opacity: 0.8, weight: 6},
                {color: '#ffffff', opacity: 0.5, weight: 4}
            ]
        },
        addWaypoints: false,
        draggableWaypoints: false,
        routeWhileDragging: false,
        showAlternatives: false,
        createMarker: function() { return null; } // Désactiver les marqueurs de Leaflet.Routing
    }).addTo(map);
    
    // Ajouter des marqueurs personnalisés pour le départ et l'arrivée
    addCustomRouteMarkers(from, to);
    
    // Écouter l'événement de calcul d'itinéraire
    routingControl.on('routesfound', function(e) {
        // Cacher l'indicateur de chargement
        loadingIndicator.style.display = 'none';
        
        const routes = e.routes;
        const route = routes[0]; // Utiliser le premier itinéraire
        
        // Calculer la distance en kilomètres (arrondie à 1 décimale)
        const distanceInKm = Math.round(route.summary.totalDistance / 100) / 10;
        
        // Calculer la durée en minutes (arrondie à la minute près)
        const durationInMinutes = Math.round(route.summary.totalTime / 60);
        
        // Calculer le prix
        const price = calculatePrice(distanceInKm);
        
        // Mettre à jour les données de l'itinéraire
        routeData.distance = distanceInKm;
        routeData.duration = durationInMinutes;
        routeData.price = price;
        
        // Mettre à jour l'affichage
        distanceElement.textContent = `${distanceInKm} km`;
        durationElement.textContent = formatDuration(durationInMinutes);
        priceElement.textContent = `${price} FCFA`;
        
        // Afficher les détails du trajet
        journeyDetails.style.display = 'block';
        confirmOrderBtn.style.display = 'block';
        
        // Centrer la carte pour montrer l'ensemble de l'itinéraire
        map.fitBounds(L.latLngBounds(
            [from.lat, from.lng],
            [to.lat, to.lng]
        ).pad(0.3));
    });
    
    // Gérer les erreurs de calcul d'itinéraire
    routingControl.on('routingerror', function(e) {
        console.error('Erreur de calcul d\'itinéraire:', e.error);
        loadingIndicator.style.display = 'none';
        showTemporaryMessage("Impossible de calculer cet itinéraire. Veuillez essayer avec d'autres adresses.", 4000);
    });
}

// Ajouter des marqueurs personnalisés pour le départ et l'arrivée
function addCustomRouteMarkers(from, to) {
    // Supprimer les marqueurs existants s'il y en a
    if (window.pickupMarker) window.pickupMarker.remove();
    if (window.destinationMarker) window.destinationMarker.remove();
    
    // Icône pour le point de départ (vert)
    const pickupIcon = L.divIcon({
        html: '<div style="background-color: #4CAF50; width: 14px; height: 14px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 3px rgba(0,0,0,0.4);"></div>',
        className: 'pickup-marker-icon',
        iconSize: [20, 20],
        iconAnchor: [10, 10]
    });
    
    // Icône pour la destination (rouge)
    const destinationIcon = L.divIcon({
        html: '<div style="background-color: #F44336; width: 14px; height: 14px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 3px rgba(0,0,0,0.4);"></div>',
        className: 'destination-marker-icon',
        iconSize: [20, 20],
        iconAnchor: [10, 10]
    });
    
    // Ajouter les marqueurs à la carte
    window.pickupMarker = L.marker([from.lat, from.lng], {
        icon: pickupIcon,
        zIndexOffset: 1000
    }).addTo(map);
    
    window.destinationMarker = L.marker([to.lat, to.lng], {
        icon: destinationIcon,
        zIndexOffset: 1000
    }).addTo(map);
}

/**
 * Interface utilisateur et événements
 */

// Fonction pour afficher un message temporaire
function showTemporaryMessage(message, duration = 3000) {
    const messageContainer = document.createElement('div');
    messageContainer.classList.add('temporary-message');
    messageContainer.textContent = message;
    
    document.body.appendChild(messageContainer);
    
    // Animation d'entrée
    setTimeout(() => {
        messageContainer.classList.add('show');
    }, 10);
    
    // Animation de sortie et suppression
    setTimeout(() => {
        messageContainer.classList.remove('show');
        messageContainer.classList.add('hide');
        
        setTimeout(() => {
            document.body.removeChild(messageContainer);
        }, 300);
    }, duration);
}

// Navigation mobile
hamburger.addEventListener('click', () => {
    mobileNav.classList.toggle('open');
    navOverlay.classList.toggle('show');
    document.body.classList.toggle('no-scroll');
});

navOverlay.addEventListener('click', () => {
    mobileNav.classList.remove('open');
    navOverlay.classList.remove('show');
    document.body.classList.remove('no-scroll');
});

// Gestion de la recherche d'itinéraire
pickupInput.addEventListener('input', function() {
    const query = this.value.trim();
    
    if (query.length >= 2) {
        // Effectuer la recherche et afficher les suggestions
        geocode(query, results => {
            pickupResults.innerHTML = '';
            
            if (results.length === 0) {
                pickupResults.style.display = 'none';
                return;
            }
            
            results.forEach(result => {
                const item = document.createElement('div');
                item.classList.add('search-result-item');
                
                // Simplifier le nom affiché
                let displayName = result.display_name;
                if (!result.type || result.type !== "popular") {
                    // Pour les résultats Nominatim, simplifier le nom d'affichage
                    const parts = displayName.split(',');
                    if (parts.length > 3) {
                        displayName = parts.slice(0, 3).join(',');
                    }
                }
                
                item.textContent = displayName;
                
                item.addEventListener('click', () => {
                    pickupInput.value = displayName;
                    routeData.pickup = displayName;
                    routeData.pickupCoords = {
                        lat: parseFloat(result.lat),
                        lng: parseFloat(result.lon)
                    };
                    pickupResults.style.display = 'none';
                });
                
                pickupResults.appendChild(item);
            });
            
            pickupResults.style.display = 'block';
        });
    } else {
        pickupResults.style.display = 'none';
    }
});

destinationInput.addEventListener('input', function() {
    const query = this.value.trim();
    
    if (query.length >= 2) {
        // Effectuer la recherche et afficher les suggestions
        geocode(query, results => {
            destinationResults.innerHTML = '';
            
            if (results.length === 0) {
                destinationResults.style.display = 'none';
                return;
            }
            
            results.forEach(result => {
                const item = document.createElement('div');
                item.classList.add('search-result-item');
                
                // Simplifier le nom affiché
                let displayName = result.display_name;
                if (!result.type || result.type !== "popular") {
                    // Pour les résultats Nominatim, simplifier le nom d'affichage
                    const parts = displayName.split(',');
                    if (parts.length > 3) {
                        displayName = parts.slice(0, 3).join(',');
                    }
                }
                
                item.textContent = displayName;
                
                item.addEventListener('click', () => {
                    destinationInput.value = displayName;
                    routeData.destination = displayName;
                    routeData.destinationCoords = {
                        lat: parseFloat(result.lat),
                        lng: parseFloat(result.lon)
                    };
                    destinationResults.style.display = 'none';
                });
                
                destinationResults.appendChild(item);
            });
            
            destinationResults.style.display = 'block';
        });
    } else {
        destinationResults.style.display = 'none';
    }
});

// Masquer les résultats de recherche lorsqu'on clique ailleurs
document.addEventListener('click', function(e) {
    if (!pickupInput.contains(e.target) && !pickupResults.contains(e.target)) {
        pickupResults.style.display = 'none';
    }
    
    if (!destinationInput.contains(e.target) && !destinationResults.contains(e.target)) {
        destinationResults.style.display = 'none';
    }
});

// Rechercher un itinéraire
searchRouteBtn.addEventListener('click', () => {
    const pickup = pickupInput.value.trim();
    const destination = destinationInput.value.trim();
    
    if (!pickup || !destination) {
        showTemporaryMessage('Veuillez entrer un point de départ et une destination');
        return;
    }
    
    // Si les coordonnées sont déjà définies, calculer l'itinéraire directement
    if (routeData.pickupCoords && routeData.pickupCoords.lat && 
        routeData.destinationCoords && routeData.destinationCoords.lat) {
        calculateRoute(routeData.pickupCoords, routeData.destinationCoords);
        return;
    }
    
    // Sinon, géocoder les adresses
    showTemporaryMessage('Recherche de l\'itinéraire...');
    
    // Géocoder le point de départ si nécessaire
    if (!routeData.pickupCoords || !routeData.pickupCoords.lat) {
        geocode(pickup, pickupResults => {
            if (pickupResults.length === 0) {
                showTemporaryMessage('Point de départ introuvable');
                return;
            }
            
            routeData.pickupCoords = {
                lat: parseFloat(pickupResults[0].lat),
                lng: parseFloat(pickupResults[0].lon)
            };
            
            // Géocoder la destination si nécessaire
            if (!routeData.destinationCoords || !routeData.destinationCoords.lat) {
                geocode(destination, destResults => {
                    if (destResults.length === 0) {
                        showTemporaryMessage('Destination introuvable');
                        return;
                    }
                    
                    routeData.destinationCoords = {
                        lat: parseFloat(destResults[0].lat),
                        lng: parseFloat(destResults[0].lon)
                    };
                    
                    // Calculer l'itinéraire
                    calculateRoute(routeData.pickupCoords, routeData.destinationCoords);
                });
            } else {
                calculateRoute(routeData.pickupCoords, routeData.destinationCoords);
            }
        });
    } else if (!routeData.destinationCoords || !routeData.destinationCoords.lat) {
        // Géocoder seulement la destination
        geocode(destination, destResults => {
            if (destResults.length === 0) {
                showTemporaryMessage('Destination introuvable');
                return;
            }
            
            routeData.destinationCoords = {
                lat: parseFloat(destResults[0].lat),
                lng: parseFloat(destResults[0].lon)
            };
            
            // Calculer l'itinéraire
            calculateRoute(routeData.pickupCoords, routeData.destinationCoords);
        });
    } else {
        // Les deux coordonnées sont disponibles
        calculateRoute(routeData.pickupCoords, routeData.destinationCoords);
    }
});

// Confirmer une commande
confirmOrderBtn.addEventListener('click', () => {
    modalDistance.textContent = distanceElement.textContent;
    modalPrice.textContent = priceElement.textContent;
    confirmationModal.style.display = 'flex';
});

// Annuler une commande
cancelOrderBtn.addEventListener('click', () => {
    confirmationModal.style.display = 'none';
});

// Confirmer définitivement une commande
finalConfirmBtn.addEventListener('click', () => {
    // Désactiver le bouton pour éviter les clics multiples
    finalConfirmBtn.disabled = true;
    finalConfirmBtn.textContent = 'Commande en cours...';
    
    // Créer une nouvelle commande dans Firebase
    const newOrderRef = database.ref('orders').push();
    const order = {
        userId: localStorage.getItem('taxiMotoUserId'),
        userName: userInfo ? userInfo.firstName + ' ' + userInfo.lastName : 'Utilisateur',
        userPhone: userInfo ? userInfo.phone : '',
        pickup: routeData.pickup,
        destination: routeData.destination,
        pickupCoords: routeData.pickupCoords,
        destinationCoords: routeData.destinationCoords,
        distance: routeData.distance,
        duration: routeData.duration,
        price: routeData.price,
        status: 'pending', // En attente d'un chauffeur
        timestamp: firebase.database.ServerValue.TIMESTAMP
    };
    
    newOrderRef.set(order)
        .then(() => {
            // Fermer le modal de confirmation
            confirmationModal.style.display = 'none';
            
            // Enregistrer l'ID de la commande en cours
            currentOrderId = newOrderRef.key;
            
            // Afficher un message de succès
            showTemporaryMessage('Commande enregistrée! Recherche d\'un chauffeur...', 5000);
            
            // Commencer à surveiller l'affectation d'un chauffeur
            watchDriverAssignment(currentOrderId);
        })
        .catch(error => {
            console.error('Erreur lors de la création de la commande:', error);
            finalConfirmBtn.disabled = false;
            finalConfirmBtn.textContent = 'Confirmer';
            showTemporaryMessage('Erreur lors de la création de la commande. Veuillez réessayer.');
        });
});

// Surveiller l'affectation d'un chauffeur
function watchDriverAssignment(orderId) {
    const orderRef = database.ref('orders/' + orderId);
    
    // Écouter les changements de la commande
    orderRef.on('value', snapshot => {
        const orderData = snapshot.val();
        
        if (orderData && orderData.driver) {
            // Un chauffeur a été assigné
            // Afficher le modal avec les informations du chauffeur
            driverName.textContent = orderData.driver.name || 'Chauffeur';
            driverPhone.textContent = orderData.driver.phone || 'N/A';
            driverPlate.textContent = orderData.driver.plate || 'N/A';
            driverAssignedModal.style.display = 'flex';
            
            // Arrêter d'écouter les changements
            orderRef.off('value');
        }
    });
    
    // Arrêter l'écoute après 5 minutes pour éviter les problèmes
    setTimeout(() => {
        orderRef.off('value');
    }, 5 * 60 * 1000);
}

// Fermer le modal de chauffeur assigné
acknowledgeDriverBtn.addEventListener('click', () => {
    driverAssignedModal.style.display = 'none';
});

// Masquer les résultats quand on clique ailleurs
document.addEventListener('click', (e) => {
    if (!pickupInput.contains(e.target) && !pickupResults.contains(e.target)) {
        pickupResults.style.display = 'none';
    }
    
    if (!destinationInput.contains(e.target) && !destinationResults.contains(e.target)) {
        destinationResults.style.display = 'none';
    }
});

// Écouteur d'événement pour entrée clavier sur les champs de recherche
pickupInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
        pickupResults.style.display = 'none';
        destinationInput.focus();
    }
});

destinationInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
        destinationResults.style.display = 'none';
        searchRouteBtn.click();
    }
});

// Détecter la connexion réseau
window.addEventListener('online', () => {
    showTemporaryMessage('Vous êtes connecté au réseau', 2000);
});

window.addEventListener('offline', () => {
    showTemporaryMessage('Vous êtes hors ligne. Certaines fonctionnalités peuvent être limitées.', 5000);
});

// Initialiser l'application
document.addEventListener('DOMContentLoaded', () => {
    checkUserRegistration();
});
</script>

<script>
    // Variables globales
let activeOrderPanel = document.createElement('div');
let isOrderActive = false;

// Afficher le panneau de commande active avec bouton d'annulation
function showActiveOrderPanel(orderId, driverPhoneNumber = '') {
    // Créer ou mettre à jour le panneau de commande active
    if (!document.body.contains(activeOrderPanel)) {
        activeOrderPanel = document.createElement('div');
        activeOrderPanel.id = 'activeOrderPanel';
        activeOrderPanel.classList.add('active-order-panel');
        document.body.appendChild(activeOrderPanel);
    }

    // Mettre à jour le contenu du panneau
    activeOrderPanel.innerHTML = `
        <div class="active-order-content">
            <div class="active-order-header">
                <h3>Commande en cours</h3>
                <p>Destination: <span id="activeOrderDestination">${routeData.destination || 'Non spécifié'}</span></p>
            </div>
            <div class="active-order-driver" id="activeOrderDriverInfo"></div>
            <button id="cancelActiveOrderBtn" class="cancel-order-btn">Annuler la commande</button>
        </div>
    `;

    // Ajouter le style si pas encore fait
    if (!document.getElementById('activeOrderPanelStyle')) {
        const style = document.createElement('style');
        style.id = 'activeOrderPanelStyle';
        style.textContent = `
            .active-order-panel {
                position: fixed;
                bottom: 20px;
                left: 50%;
                transform: translateX(-50%);
                width: 90%;
                max-width: 400px;
                background-color: white;
                border-radius: 10px;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
                z-index: 1001;
                overflow: hidden;
                transition: all 0.3s ease;
            }
            .active-order-content { padding: 15px; }
            .active-order-header { margin-bottom: 15px; }
            .active-order-header h3 { margin: 0 0 8px 0; color: #333; }
            .active-order-header p { margin: 0; font-size: 14px; color: #666; }
            .cancel-order-btn {
                width: 100%;
                padding: 12px;
                background-color: #ff5252;
                color: white;
                border: none;
                border-radius: 5px;
                font-weight: bold;
                cursor: pointer;
                transition: background-color 0.2s;
            }
            .cancel-order-btn:hover { background-color: #ff1a1a; }
            .driver-info-section {
                background: #f7f7f7;
                border-radius: 7px;
                margin: 10px 0 15px 0;
                padding: 10px;
                font-size: 14px;
            }
            .driver-info-section strong { color: #333; }
        `;
        document.head.appendChild(style);
    }

    // Ajouter l'événement d'annulation
    document.getElementById('cancelActiveOrderBtn').addEventListener('click', () => {
        // Si numéro du chauffeur disponible, ouvrir l'application téléphone avec ce numéro
        if (driverPhoneNumber && typeof driverPhoneNumber === 'string') {
            window.location.href = `tel:${driverPhoneNumber}`;
        } else if (
            window.currentDriverPhoneNumber &&
            typeof window.currentDriverPhoneNumber === 'string'
        ) {
            window.location.href = `tel:${window.currentDriverPhoneNumber}`;
        } else {
            showTemporaryMessage('Numéro du chauffeur indisponible.', 3000);
        }
        // Annuler la commande côté base de données
        cancelOrder(orderId);
    });

    // Afficher le panneau
    activeOrderPanel.style.display = 'block';
    isOrderActive = true;
}

// Fonction pour masquer le panneau de commande active
function hideActiveOrderPanel() {
    if (activeOrderPanel) {
        activeOrderPanel.style.display = 'none';
        isOrderActive = false;
    }
}

// Fonction pour annuler une commande
function cancelOrder(orderId) {
    if (!orderId) {
        showTemporaryMessage('Impossible d\'annuler: aucune commande active');
        return;
    }
    // Référence à la commande dans Firebase
    const orderRef = database.ref('orders/' + orderId);

    // Mettre à jour le statut de la commande
    orderRef.update({
        status: 'cancelled',
        cancelledAt: firebase.database.ServerValue.TIMESTAMP,
        cancelledBy: 'client'
    })
    .then(() => {
        showTemporaryMessage('Commande annulée avec succès', 3000);
        hideActiveOrderPanel();
        currentOrderId = null;

        // Nettoyer l'itinéraire si affiché
        if (routingControl) {
            map.removeControl(routingControl);
            routingControl = null;
        }
        // Supprimer les marqueurs d'itinéraire
        if (window.pickupMarker) window.pickupMarker.remove();
        if (window.destinationMarker) window.destinationMarker.remove();

        // Réinitialiser les champs pour permettre une nouvelle commande
        journeyDetails.style.display = 'none';
        confirmOrderBtn.style.display = 'none';
    })
    .catch(error => {
        console.error('Erreur lors de l\'annulation de la commande:', error);
        showTemporaryMessage('Erreur lors de l\'annulation. Veuillez réessayer.', 3000);
    });
}

// Fonction de confirmation finale de la commande
finalConfirmBtn.addEventListener('click', () => {
    // Désactiver le bouton pour éviter les clics multiples
    finalConfirmBtn.disabled = true;
    finalConfirmBtn.textContent = 'Commande en cours...';

    // Créer une nouvelle commande dans Firebase
    const newOrderRef = database.ref('orders').push();
    const order = {
        userId: localStorage.getItem('taxiMotoUserId'),
        userName: userInfo ? userInfo.firstName + ' ' + userInfo.lastName : 'Utilisateur',
        userPhone: userInfo ? userInfo.phone : '',
        pickup: routeData.pickup,
        destination: routeData.destination,
        pickupCoords: routeData.pickupCoords,
        destinationCoords: routeData.destinationCoords,
        distance: routeData.distance,
        duration: routeData.duration,
        price: routeData.price,
        status: 'pending', // En attente d'un chauffeur
        timestamp: firebase.database.ServerValue.TIMESTAMP
    };

    newOrderRef.set(order)
        .then(() => {
            // Fermer le modal de confirmation
            confirmationModal.style.display = 'none';
            // Enregistrer l'ID de la commande en cours
            currentOrderId = newOrderRef.key;
            // Afficher un message de succès
            showTemporaryMessage('Commande enregistrée! Recherche d\'un chauffeur...', 5000);
            // Commencer à surveiller l'affectation d'un chauffeur
            watchDriverAssignment(currentOrderId);
            // Afficher le panneau de commande active
            showActiveOrderPanel(currentOrderId);
        })
        .catch(error => {
            console.error('Erreur lors de la création de la commande:', error);
            finalConfirmBtn.disabled = false;
            finalConfirmBtn.textContent = 'Confirmer';
            showTemporaryMessage('Erreur lors de la création de la commande. Veuillez réessayer.');
        });
});

// Surveiller l'affectation du chauffeur et mettre à jour le panneau si besoin
function watchDriverAssignment(orderId) {
    const orderRef = database.ref('orders/' + orderId);

    // Écouter les changements de la commande
    orderRef.on('value', snapshot => {
        const orderData = snapshot.val();

        if (!orderData) {
            // La commande n'existe plus
            hideActiveOrderPanel();
            return;
        }

        // Vérifier si la commande est annulée
        if (orderData.status === 'cancelled') {
            hideActiveOrderPanel();
            // Si annulée par le fournisseur, informer le client
            if (orderData.cancelledBy === 'driver') {
                showTemporaryMessage('Votre commande a été annulée par le chauffeur', 5000);
            }
            // Arrêter d'écouter les changements
            orderRef.off('value');
            return;
        }

        // Si un chauffeur est assigné, afficher ses infos et mémoriser le numéro
        if (orderData && orderData.driver) {
            const driverInfoHTML = `
                <div class="driver-info-section">
                    <p><strong>Chauffeur:</strong> ${orderData.driver.name || 'N/A'}</p>
                    <p><strong>Numéro:</strong> <span id="driverPhoneSpan">${orderData.driver.phone || 'N/A'}</span></p>
                    <p><strong>Plaque:</strong> ${orderData.driver.plate || 'N/A'}</p>
                </div>
            `;
            const driverInfoContainer = document.getElementById('activeOrderDriverInfo');
            if (driverInfoContainer) {
                driverInfoContainer.innerHTML = driverInfoHTML;
            }
            // Stocker le numéro pour l'utiliser lors de l'annulation
            window.currentDriverPhoneNumber = orderData.driver.phone || '';
        }
    });

    // Arrêter l'écoute après 30 minutes pour éviter les problèmes de mémoire
    setTimeout(() => {
        orderRef.off('value');
    }, 30 * 60 * 1000);
}

// Quand l'utilisateur reconnaît le chauffeur, masquer le modal et afficher le panneau actif
acknowledgeDriverBtn.addEventListener('click', () => {
    driverAssignedModal.style.display = 'none';
    // S'assurer que le panneau de commande active est toujours visible
    if (currentOrderId && !isOrderActive) {
        // Prendre le numéro du chauffeur si possible
        const driverPhone = window.currentDriverPhoneNumber || '';
        showActiveOrderPanel(currentOrderId, driverPhone);
    }
});
</script>
</body>
</html>
