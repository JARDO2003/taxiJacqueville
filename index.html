<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TAXI MOTO JACQUEVILLE - Commandez votre taxi moto</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    <!-- Leaflet Routing Machine CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet-routing-machine/3.2.12/leaflet-routing-machine.css" />
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            font-size: 16px;
        }
        
        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 15px;
        }
        
        header {
            background-color: #ffcc00;
            color: #222;
            padding: 12px 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            font-size: 18px;
            font-weight: bold;
            display: flex;
            align-items: center;
        }
        
        .logo i {
            margin-right: 8px;
            font-size: 20px;
        }
        
        .hamburger {
            display: none;
            font-size: 24px;
            cursor: pointer;
        }
        
        nav ul {
            display: flex;
            list-style: none;
        }
        
        nav ul li {
            margin-left: 15px;
        }
        
        nav ul li a {
            color: #222;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s;
            font-size: 14px;
        }
        
        nav ul li a:hover {
            color: #555;
        }
        
        .hero {
            background-color: #ffcc00;
            padding: 30px 0;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .hero h1 {
            font-size: 24px;
            margin-bottom: 15px;
            color: #222;
        }
        
        .hero p {
            font-size: 16px;
            margin-bottom: 20px;
            color: #444;
        }
        
        .booking-form {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .booking-form h2 {
            font-size: 20px;
            margin-bottom: 15px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #444;
            font-size: 14px;
        }
        
        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        #map {
            height: 250px;
            width: 100%;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        
        .journey-details {
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
            display: none;
        }
        
        .journey-details h3 {
            margin-bottom: 10px;
            color: #333;
            font-size: 16px;
        }
        
        .detail-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid #eee;
            font-size: 14px;
        }
        
        .detail-row:last-child {
            border-bottom: none;
        }
        
        .detail-label {
            font-weight: 500;
            color: #555;
        }
        
        .detail-value {
            color: #333;
            font-weight: bold;
        }
        
        .btn {
            background-color: #ffcc00;
            color: #222;
            border: none;
            padding: 12px 20px;
            font-size: 16px;
            font-weight: 600;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .btn:hover {
            background-color: #f0c000;
        }
        
        .btn-block {
            display: block;
            width: 100%;
        }
        
        .features {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .feature {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        
        .feature i {
            font-size: 30px;
            color: #ffcc00;
            margin-bottom: 10px;
        }
        
        .feature h3 {
            margin-bottom: 8px;
            color: #333;
            font-size: 18px;
        }
        
        .feature p {
            color: #666;
            line-height: 1.4;
            font-size: 14px;
        }
        
        footer {
            background-color: #222;
            color: white;
            padding: 25px 0 15px;
            text-align: center;
        }
        
        .footer-content {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .footer-section {
            text-align: center;
            margin-bottom: 10px;
        }
        
        .footer-section h3 {
            margin-bottom: 10px;
            color: #ffcc00;
            font-size: 16px;
        }
        
        .footer-section p, .footer-section a {
            color: #ddd;
            margin-bottom: 8px;
            display: block;
            text-decoration: none;
            transition: color 0.3s;
            font-size: 14px;
        }
        
        .footer-section a:hover {
            color: #ffcc00;
        }
        
        .copyright {
            padding-top: 15px;
            border-top: 1px solid #444;
            color: #aaa;
            font-size: 12px;
        }
        
        #confirmOrderBtn {
            display: none;
        }
        
        #loadingIndicator {
            display: none;
            text-align: center;
            margin: 15px 0;
        }
        
        .spinner {
            border: 4px solid rgba(255, 204, 0, 0.3);
            border-radius: 50%;
            border-top: 4px solid #ffcc00;
            width: 25px;
            height: 25px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            overflow: auto;
        }
        
        .modal-content {
            background-color: white;
            margin: 20% auto 0;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 400px;
            text-align: center;
        }
        
        .modal h2 {
            margin-bottom: 15px;
            color: #333;
            font-size: 20px;
        }
        
        .modal p {
            margin-bottom: 20px;
            color: #555;
            line-height: 1.4;
            font-size: 14px;
        }
        
        .btn-group {
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .btn-secondary {
            background-color: #ddd;
            color: #333;
        }
        
        .btn-secondary:hover {
            background-color: #ccc;
        }
        
        .location-permission {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            z-index: 2000;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .permission-content {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            width: 90%;
            max-width: 350px;
        }
        
        .permission-content h2 {
            margin-bottom: 15px;
            color: #333;
            font-size: 20px;
        }
        
        .permission-content p {
            margin-bottom: 20px;
            color: #555;
            line-height: 1.4;
            font-size: 14px;
        }
        
        #locationSearchBtn {
            margin-bottom: 15px;
        }
        
        .address-results {
            max-height: 150px;
            overflow-y: auto;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            display: none;
        }
        
        .address-item {
            padding: 8px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            font-size: 13px;
        }
        
        .address-item:hover {
            background-color: #f5f5f5;
        }
        
        .other-services {
            padding: 30px 0;
            background-color: #f9f9f9;
        }
        
        .section-title {
            text-align: center;
            margin-bottom: 20px;
            color: #333;
            font-size: 22px;
        }
        
        .services-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
        }
        
        .service-card {
            width: 100%;
            max-width: 350px;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .service-image {
            height: 180px;
            background-size: cover;
            background-position: center;
            position: relative;
        }
        
        .service-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
            padding: 20px 15px;
            color: white;
            text-align: center;
        }
        
        .service-overlay h3 {
            font-size: 18px;
            margin-bottom: 8px;
        }
        
        .service-overlay p {
            margin-bottom: 12px;
            font-size: 14px;
        }
        
        .service-btn {
            display: inline-block;
            padding: 8px 18px;
            background-color: #ffcc00;
            color: #222;
            border-radius: 5px;
            text-decoration: none;
            font-weight: 600;
            transition: background-color 0.3s;
            font-size: 14px;
        }
        
        .service-btn:hover {
            background-color: #f0c000;
        }

        /* Notification de chauffeur */
        #driverAssignedModal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            overflow: auto;
        }
        
        .driver-info {
            margin-top: 15px;
            padding: 15px;
            background-color: #f5f5f5;
            border-radius: 5px;
        }
        
        .driver-info p {
            margin-bottom: 10px;
            font-size: 15px;
        }
        
        .driver-info p strong {
            font-weight: bold;
            color: #333;
        }
        
        /* Formulaire d'inscription */
        #registrationModal {
            display: flex;
            position: fixed;
            z-index: 3000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
            justify-content: center;
            align-items: center;
        }
        
        .registration-form {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 450px;
        }
        
        .registration-form h2 {
            margin-bottom: 20px;
            text-align: center;
            color: #333;
        }
        
        .welcome-message {
            display: none;
            background-color: #e9f7ef;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            border-left: 4px solid #2ecc71;
        }
        
        .welcome-message p {
            margin: 0;
            color: #27ae60;
        }
        
        .profile-info {
            display: flex;
            align-items: center;
            margin-left: auto;
        }
        
        .profile-info span {
            margin-right: 10px;
            font-size: 14px;
            font-weight: 500;
        }
        
        /* Styles responsive */
        @media (min-width: 768px) {
            .logo {
                font-size: 24px;
            }
            
            .logo i {
                font-size: 28px;
            }
            
            .hero h1 {
                font-size: 36px;
            }
            
            .hero p {
                font-size: 18px;
            }
            
            #map {
                height: 400px;
            }
            
            .features {
                flex-direction: row;
                justify-content: space-between;
            }
            
            .feature {
                width: 32%;
            }
            
            .footer-content {
                flex-direction: row;
                justify-content: space-between;
            }
            
            .footer-section {
                text-align: left;
                width: 30%;
            }
            
            nav ul li a {
                font-size: 16px;
            }
            
            .modal-content {
                margin: 15% auto 0;
            }
        }
        
        @media (max-width: 767px) {
            .hamburger {
                display: block;
            }
            
            nav {
                position: fixed;
                top: 50px;
                left: -100%;
                width: 80%;
                height: 100vh;
                background-color: #fff;
                box-shadow: 2px 0 5px rgba(0,0,0,0.1);
                transition: left 0.3s ease;
                z-index: 1000;
            }
            
            nav.active {
                left: 0;
            }
            
            nav ul {
                flex-direction: column;
                padding: 20px;
            }
            
            nav ul li {
                margin: 0 0 15px 0;
                width: 100%;
            }
            
            nav ul li a {
                display: block;
                padding: 8px 0;
                font-size: 16px;
            }
            
            .overlay {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0,0,0,0.5);
                z-index: 999;
            }
            
            .overlay.active {
                display: block;
            }
        }
    </style>
</head>
<body>
    <!-- Modal d'inscription -->
    <div id="registrationModal" class="modal">
        <div class="registration-form">
            <h2>Bienvenue chez TAXI MOTO JACQUEVILLE</h2>
            <p>Pour utiliser notre service, veuillez vous inscrire :</p>
            
            <div class="form-group">
                <label for="regFirstName">Prénom</label>
                <input type="text" id="regFirstName" placeholder="Votre prénom" required>
            </div>
            
            <div class="form-group">
                <label for="regLastName">Nom</label>
                <input type="text" id="regLastName" placeholder="Votre nom" required>
            </div>
            
            <div class="form-group">
                <label for="regPhone">Numéro de téléphone</label>
                <input type="tel" id="regPhone" placeholder="Exemple: 07XXXXXXXX" required>
            </div>
            
            <button class="btn btn-block" id="registerBtn">S'inscrire</button>
        </div>
    </div>
    
    <div id="locationPermission" class="location-permission">
        <div class="permission-content">
            <h2>Autorisation de localisation</h2>
            <p>Pour utiliser notre service de taxi moto, nous avons besoin d'accéder à votre position actuelle.</p>
            <p>Cela nous permettra de vous proposer un itinéraire précis et d'envoyer un chauffeur à votre emplacement exact.</p>
            <button class="btn" id="allowLocationBtn">Autoriser l'accès</button>
        </div>
    </div>
    
    <div class="overlay" id="navOverlay"></div>
    
    <header>
        <div class="container header-content">
            <div class="logo">
                <i class="fas fa-motorcycle"></i> TAXI MOTO JACQUEVILLE
            </div>
            <div class="profile-info">
                <span id="userNameDisplay"></span>
            </div>
            <div class="hamburger" id="hamburger">
                <i class="fas fa-bars"></i>
            </div>
            <nav id="mobileNav">
                <ul>
                    <li><a href="#" class="active">Accueil</a></li>
                    <li><a href="apros.html">À propos</a></li>
                    <li><a href="contact.html">Contact</a></li>
                </ul>
            </nav>
        </div>
    </header>
    
    <section class="hero">
        <div class="container">
            <div class="welcome-message" id="welcomeMessage">
                <p>Bienvenue <span id="welcomeUserName"></span> !</p>
            </div>
            <h1>Commandez votre taxi moto en quelques clics</h1>
            <p>Rapide, fiable et économique - Nous vous conduisons à destination en toute sécurité</p>
        </div>
    </section>
    
    <main class="container">
        <div class="booking-form">
            <h2>Réservez votre course</h2>
            <div class="form-group">
                <label for="pickup">Point de départ</label>
                <input type="text" id="pickup" placeholder="Votre position actuelle se chargera automatiquement...">
                <div id="pickupResults" class="address-results"></div>
            </div>
            
            <div class="form-group">
                <label for="destination">Destination</label>
                <input type="text" id="destination" placeholder="Où souhaitez-vous aller ?">
                <div id="destinationResults" class="address-results"></div>
            </div>
            
            <div id="map"></div>
            
            <div id="loadingIndicator">
                <div class="spinner"></div>
                <p>Calcul de l'itinéraire en cours...</p>
            </div>
            
            <div class="journey-details" id="journeyDetails">
                <h3>Détails de la course</h3>
                <div class="detail-row">
                    <span class="detail-label">Distance:</span>
                    <span class="detail-value" id="distance">-- km</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Durée estimée:</span>
                    <span class="detail-value" id="duration">-- min</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Prix:</span>
                    <span class="detail-value" id="price">-- FCFA</span>
                </div>
            </div>
            
            <button class="btn btn-block" id="searchRouteBtn">Rechercher l'itinéraire</button>
            <button class="btn btn-block" id="confirmOrderBtn">Confirmer la commande</button>
        </div>
        
        <div class="features">
            <div class="feature">
                <i class="fas fa-bolt"></i>
                <h3>Rapide</h3>
                <p>Évitez les embouteillages et arrivez à destination rapidement</p>
            </div>
            <div class="feature">
                <i class="fas fa-money-bill-wave"></i>
                <h3>Économique</h3>
                <p>Tarifs compétitifs avec prix fixe à 100 FCFA par km</p>
            </div>
            <div class="feature">
                <i class="fas fa-shield-alt"></i>
                <h3>Sécurisé</h3>
                <p>Chauffeurs professionnels et casques fournis pour votre sécurité</p>
            </div>
        </div>
    </main>
    
    <div id="confirmationModal" class="modal">
        <div class="modal-content">
            <h2>Confirmer votre commande</h2>
            <p>Vous êtes sur le point de commander un taxi moto pour un trajet de <span id="modalDistance">-- km</span> au prix de <span id="modalPrice">-- FCFA</span>.</p>
            <p>Êtes-vous d'accord avec ce prix ?</p>
            <div class="btn-group">
                <button class="btn btn-secondary" id="cancelOrderBtn">Annuler</button>
                <button class="btn" id="finalConfirmBtn">Confirmer</button>
            </div>
        </div>
    </div>

    <!-- Modal pour les informations du chauffeur -->
    <div id="driverAssignedModal" class="modal">
        <div class="modal-content">
            <h2>Un chauffeur a accepté votre course!</h2>
            <div class="driver-info">
                <p><strong>Nom du chauffeur:</strong> <span id="driverName">--</span></p>
                <p><strong>Numéro de téléphone:</strong> <span id="driverPhone">--</span></p>
                <p><strong>Plaque d'immatriculation:</strong> <span id="driverPlate">--</span></p>
            </div>
            <p>Le chauffeur est en route vers votre emplacement.</p>
            <div class="btn-group">
                <button class="btn" id="acknowledgeDriverBtn">J'ai compris</button>
            </div>
        </div>
    </div>

    <section class="other-services">
        <div class="container">
            <h2 class="section-title">Autres services</h2>
            <div class="services-container">
                <div class="service-card">
                    <div class="service-image" style="background-image: url('/api/placeholder/400/200');">
                        <div class="service-overlay">
                            <h3>Eden Livraison</h3>
                            <p>Service de livraison rapide et fiable</p>
                            <a href="eden.html" class="service-btn">Accéder</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    
    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>À propos de nous</h3>
                    <p>TAXI MOTO EXPRESS est votre partenaire de confiance pour vos déplacements urbains rapides et économiques.</p>
                </div>
                <div class="footer-section">
                    <h3>Liens utiles</h3>
                    <a href="#">Conditions d'utilisation</a>
                    <a href="#">Politique de confidentialité</a>
                    <a href="#">FAQ</a>
                </div>
                <div class="footer-section">
                    <h3>Contact</h3>
                    <p>Email: utilisateurmarcio@gmail.com</p>
                    <p>Téléphone: +2250172369840</p>
                </div>
            </div>
            <div class="copyright">
                <p>&copy; 2025 TAXI MOTO EXPRESS - Tous droits réservés</p>
            </div>
        </div>
    </footer>

    <!-- Leaflet JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <!-- Leaflet Routing Machine -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-routing-machine/3.2.12/leaflet-routing-machine.min.js"></script>
<script>
// Configuration Firebase
const firebaseConfig = {
    apiKey: "AIzaSyBZOjPxnWZ7w9A5MdKulPSsuEcQMzj6u98",
    authDomain: "transport-a8225.firebaseapp.com",
    databaseURL: "https://transport-a8225-default-rtdb.firebaseio.com",
    projectId: "transport-a8225",
    storageBucket: "transport-a8225.firebasestorage.app",
    messagingSenderId: "268859727706",
    appId: "1:268859727706:web:3368b93a20826281799d63",
    measurementId: "G-PE30CHJ409"
};

// Initialiser Firebase
firebase.initializeApp(firebaseConfig);
const database = firebase.database();

// Variables globales
let map;
let routingControl;
let currentPosition;
let currentOrderId = null;
let userInfo = null;
let routeData = {
    distance: 0,
    duration: 0,
    price: 0,
    pickup: '',
    destination: '',
    pickupCoords: {},
    destinationCoords: {}
};

// Coordonnées pour centrer la carte sur la Côte d'Ivoire
const ivoryCoastCenter = [7.539989, -5.547080]; // Latitude et longitude de la Côte d'Ivoire
const ivoryCoastBounds = [
    [4.193, -8.602], // Sud-Ouest
    [10.736, -2.493]  // Nord-Est
];

// Éléments du DOM
const registrationModal = document.getElementById('registrationModal');
const regFirstName = document.getElementById('regFirstName');
const regLastName = document.getElementById('regLastName');
const regPhone = document.getElementById('regPhone');
const registerBtn = document.getElementById('registerBtn');
const userNameDisplay = document.getElementById('userNameDisplay');
const welcomeMessage = document.getElementById('welcomeMessage');
// DOM elements (continued)
const welcomeUserName = document.getElementById('welcomeUserName');
const locationPermission = document.getElementById('locationPermission');
const allowLocationBtn = document.getElementById('allowLocationBtn');
const hamburger = document.getElementById('hamburger');
const navOverlay = document.getElementById('navOverlay');
const mobileNav = document.getElementById('mobileNav');
const pickupInput = document.getElementById('pickup');
const destinationInput = document.getElementById('destination');
const pickupResults = document.getElementById('pickupResults');
const destinationResults = document.getElementById('destinationResults');
const searchRouteBtn = document.getElementById('searchRouteBtn');
const confirmOrderBtn = document.getElementById('confirmOrderBtn');
const journeyDetails = document.getElementById('journeyDetails');
const distanceElement = document.getElementById('distance');
const durationElement = document.getElementById('duration');
const priceElement = document.getElementById('price');
const loadingIndicator = document.getElementById('loadingIndicator');
const confirmationModal = document.getElementById('confirmationModal');
const modalDistance = document.getElementById('modalDistance');
const modalPrice = document.getElementById('modalPrice');
const cancelOrderBtn = document.getElementById('cancelOrderBtn');
const finalConfirmBtn = document.getElementById('finalConfirmBtn');
const driverAssignedModal = document.getElementById('driverAssignedModal');
const driverName = document.getElementById('driverName');
const driverPhone = document.getElementById('driverPhone');
const driverPlate = document.getElementById('driverPlate');
const acknowledgeDriverBtn = document.getElementById('acknowledgeDriverBtn');

// Vérifier si l'utilisateur est déjà inscrit
function checkUserRegistration() {
    const userId = localStorage.getItem('taxiMotoUserId');
    if (userId) {
        database.ref('users/' + userId).once('value')
            .then((snapshot) => {
                if (snapshot.exists()) {
                    userInfo = snapshot.val();
                    hideRegistrationModal();
                    displayUserInfo();
                    showLocationPermission();
                } else {
                    showRegistrationModal();
                }
            })
            .catch((error) => {
                console.error("Erreur lors de la récupération des données utilisateur:", error);
                showRegistrationModal();
            });
    } else {
        showRegistrationModal();
    }
}

// Afficher le modal d'inscription
function showRegistrationModal() {
    registrationModal.style.display = 'flex';
}

// Cacher le modal d'inscription
function hideRegistrationModal() {
    registrationModal.style.display = 'none';
}

// Afficher les informations de l'utilisateur
function displayUserInfo() {
    if (userInfo) {
        userNameDisplay.textContent = userInfo.firstName;
        welcomeUserName.textContent = userInfo.firstName;
        welcomeMessage.style.display = 'block';
    }
}

// Gérer l'inscription de l'utilisateur
registerBtn.addEventListener('click', () => {
    const firstName = regFirstName.value.trim();
    const lastName = regLastName.value.trim();
    const phone = regPhone.value.trim();
    
    if (!firstName || !lastName || !phone) {
        alert('Veuillez remplir tous les champs');
        return;
    }
    
    if (!validatePhoneNumber(phone)) {
        alert('Veuillez entrer un numéro de téléphone valide');
        return;
    }
    
    // Créer un nouvel utilisateur
    const newUserRef = database.ref('users').push();
    const userData = {
        firstName: firstName,
        lastName: lastName,
        phone: phone,
        createdAt: firebase.database.ServerValue.TIMESTAMP
    };
    
    newUserRef.set(userData)
        .then(() => {
            localStorage.setItem('taxiMotoUserId', newUserRef.key);
            userInfo = userData;
            hideRegistrationModal();
            displayUserInfo();
            showLocationPermission();
        })
        .catch((error) => {
            console.error("Erreur lors de l'inscription:", error);
            alert('Une erreur est survenue. Veuillez réessayer.');
        });
});

// Valider le format du numéro de téléphone (format ivoirien)
function validatePhoneNumber(phone) {
    // Format ivoirien: 01-99 XX XX XX XX (10 chiffres)
    const regex = /^0[1-9][0-9]{8}$/;
    return regex.test(phone);
}

// Afficher le modal de permission de localisation
function showLocationPermission() {
    locationPermission.style.display = 'flex';
}

// Gérer l'autorisation de localisation
allowLocationBtn.addEventListener('click', () => {
    locationPermission.style.display = 'none';
    initMap();
});

// Initialiser la carte Leaflet
function initMap() {
    // Créer la carte
    map = L.map('map').setView(ivoryCoastCenter, 7);
    map.setMaxBounds(ivoryCoastBounds);
    
    // Ajouter la couche de carte OpenStreetMap
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '© OpenStreetMap contributors'
    }).addTo(map);
    
    // Obtenir la position actuelle
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            (position) => {
                currentPosition = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };
                
                // Centrer la carte sur la position actuelle
                map.setView([currentPosition.lat, currentPosition.lng], 15);
                
                // Ajouter un marqueur pour la position actuelle
                L.marker([currentPosition.lat, currentPosition.lng])
                    .addTo(map)
                    .bindPopup('Votre position actuelle')
                    .openPopup();
                
                // Mettre à jour le champ de saisie du point de départ
                reverseGeocode(currentPosition, (address) => {
                    pickupInput.value = address;
                    routeData.pickup = address;
                    routeData.pickupCoords = currentPosition;
                });
            },
            (error) => {
                console.error("Erreur de géolocalisation:", error);
                alert('Impossible d\'obtenir votre position. Veuillez entrer votre point de départ manuellement.');
            }
        );
    } else {
        alert('La géolocalisation n\'est pas prise en charge par votre navigateur.');
    }
}

// Fonction de géocodage inversé (coordonnées -> adresse)
function reverseGeocode(coords, callback) {
    const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${coords.lat}&lon=${coords.lng}&zoom=18&addressdetails=1`;
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            const address = data.display_name;
            callback(address);
        })
        .catch(error => {
            console.error('Erreur lors du géocodage inversé:', error);
            callback('Adresse non trouvée');
        });
}

// Fonction de géocodage (adresse -> coordonnées)
function geocode(address, callback) {
    const encodedAddress = encodeURIComponent(address);
    const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodedAddress}&limit=5`;
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            callback(data);
        })
        .catch(error => {
            console.error('Erreur lors du géocodage:', error);
            callback([]);
        });
}

// Gérer la recherche d'adresse pour le point de départ
pickupInput.addEventListener('input', () => {
    const query = pickupInput.value.trim();
    
    if (query.length > 2) {
        geocode(query, (results) => {
            displayAddressResults(results, pickupResults, (result) => {
                pickupInput.value = result.display_name;
                pickupResults.style.display = 'none';
                
                routeData.pickup = result.display_name;
                routeData.pickupCoords = {
                    lat: parseFloat(result.lat),
                    lng: parseFloat(result.lon)
                };
                
                if (routeData.destinationCoords && Object.keys(routeData.destinationCoords).length > 0) {
                    calculateRoute();
                }
            });
        });
    } else {
        pickupResults.style.display = 'none';
    }
});

// Gérer la recherche d'adresse pour la destination
destinationInput.addEventListener('input', () => {
    const query = destinationInput.value.trim();
    
    if (query.length > 2) {
        geocode(query, (results) => {
            displayAddressResults(results, destinationResults, (result) => {
                destinationInput.value = result.display_name;
                destinationResults.style.display = 'none';
                
                routeData.destination = result.display_name;
                routeData.destinationCoords = {
                    lat: parseFloat(result.lat),
                    lng: parseFloat(result.lon)
                };
                
                if (routeData.pickupCoords && Object.keys(routeData.pickupCoords).length > 0) {
                    calculateRoute();
                }
            });
        });
    } else {
        destinationResults.style.display = 'none';
    }
});

// Afficher les résultats de recherche d'adresses
function displayAddressResults(results, container, onSelectCallback) {
    container.innerHTML = '';
    
    if (results.length > 0) {
        results.forEach((result) => {
            const item = document.createElement('div');
            item.className = 'address-item';
            item.textContent = result.display_name;
            
            item.addEventListener('click', () => {
                onSelectCallback(result);
            });
            
            container.appendChild(item);
        });
        
        container.style.display = 'block';
    } else {
        container.style.display = 'none';
    }
}

// Rechercher l'itinéraire
searchRouteBtn.addEventListener('click', () => {
    const pickup = pickupInput.value.trim();
    const destination = destinationInput.value.trim();
    
    if (!pickup || !destination) {
        alert('Veuillez entrer un point de départ et une destination');
        return;
    }
    
    if (!routeData.pickupCoords || !routeData.destinationCoords) {
        loadingIndicator.style.display = 'block';
        
        if (!routeData.pickupCoords) {
            geocode(pickup, (results) => {
                if (results.length > 0) {
                    routeData.pickup = results[0].display_name;
                    routeData.pickupCoords = {
                        lat: parseFloat(results[0].lat),
                        lng: parseFloat(results[0].lon)
                    };
                    
                    if (routeData.destinationCoords) {
                        calculateRoute();
                    }
                } else {
                    loadingIndicator.style.display = 'none';
                    alert('Point de départ non trouvé');
                }
            });
        }
        
        if (!routeData.destinationCoords) {
            geocode(destination, (results) => {
                if (results.length > 0) {
                    routeData.destination = results[0].display_name;
                    routeData.destinationCoords = {
                        lat: parseFloat(results[0].lat),
                        lng: parseFloat(results[0].lon)
                    };
                    
                    if (routeData.pickupCoords) {
                        calculateRoute();
                    }
                } else {
                    loadingIndicator.style.display = 'none';
                    alert('Destination non trouvée');
                }
            });
        }
    } else {
        calculateRoute();
    }
});

// Calculer l'itinéraire
function calculateRoute() {
    loadingIndicator.style.display = 'block';
    
    // Supprimer l'itinéraire précédent
    if (routingControl) {
        map.removeControl(routingControl);
    }
    
    // Créer un nouvel itinéraire
    routingControl = L.Routing.control({
        waypoints: [
            L.latLng(routeData.pickupCoords.lat, routeData.pickupCoords.lng),
            L.latLng(routeData.destinationCoords.lat, routeData.destinationCoords.lng)
        ],
        routeWhileDragging: false,
        showAlternatives: false,
        createMarker: function() { return null; }
    }).addTo(map);
    
    // Écouter l'événement de route trouvée
    routingControl.on('routesfound', function(e) {
        const routes = e.routes;
        const route = routes[0];
        
        // Calculer la distance en kilomètres (arrondie à 2 décimales)
        const distanceInKm = (route.summary.totalDistance / 1000).toFixed(2);
        
        // Calculer la durée en minutes (arrondie à la minute près)
        const durationInMinutes = Math.round(route.summary.totalTime / 60);
        
        // Calculer le prix (100 FCFA par kilomètre + frais fixes de 500 FCFA)
        const basePrice = 500;
        const pricePerKm = 100;
        const price = basePrice + Math.round(distanceInKm * pricePerKm);
        
        // Mettre à jour les données de l'itinéraire
        routeData.distance = distanceInKm;
        routeData.duration = durationInMinutes;
        routeData.price = price;
        
        // Afficher les détails de l'itinéraire
        distanceElement.textContent = distanceInKm + ' km';
        durationElement.textContent = durationInMinutes + ' min';
        priceElement.textContent = price + ' FCFA';
        
        journeyDetails.style.display = 'block';
        confirmOrderBtn.style.display = 'block';
        searchRouteBtn.style.display = 'none';
        loadingIndicator.style.display = 'none';
    });
    
    routingControl.on('routingerror', function(e) {
        loadingIndicator.style.display = 'none';
        alert('Impossible de trouver un itinéraire entre ces deux points. Veuillez vérifier vos adresses.');
    });
}

// Confirmer la commande
confirmOrderBtn.addEventListener('click', () => {
    // Vérifier que l'itinéraire a été calculé
    if (routeData.distance > 0 && routeData.price > 0) {
        // Afficher le modal de confirmation
        modalDistance.textContent = routeData.distance + ' km';
        modalPrice.textContent = routeData.price + ' FCFA';
        confirmationModal.style.display = 'block';
    } else {
        alert('Veuillez d\'abord rechercher un itinéraire');
    }
});

// Annuler la commande
cancelOrderBtn.addEventListener('click', () => {
    confirmationModal.style.display = 'none';
});

// Confirmation finale de la commande
finalConfirmBtn.addEventListener('click', () => {
    confirmationModal.style.display = 'none';
    
    // Créer une nouvelle commande dans la base de données
    const userId = localStorage.getItem('taxiMotoUserId');
    if (!userId) {
        alert('Votre session a expiré. Veuillez vous reconnecter.');
        showRegistrationModal();
        return;
    }
    
    const newOrderRef = database.ref('orders').push();
    const orderData = {
        userId: userId,
        userName: userInfo.firstName + ' ' + userInfo.lastName,
        userPhone: userInfo.phone,
        pickup: routeData.pickup,
        destination: routeData.destination,
        pickupCoords: routeData.pickupCoords,
        destinationCoords: routeData.destinationCoords,
        distance: routeData.distance,
        duration: routeData.duration,
        price: routeData.price,
        status: 'pending', // pending, accepted, completed, cancelled
        createdAt: firebase.database.ServerValue.TIMESTAMP
    };
    
    newOrderRef.set(orderData)
        .then(() => {
            currentOrderId = newOrderRef.key;
            alert('Votre commande a été enregistrée. Nous recherchons un chauffeur disponible...');
            
            // Écouter les modifications de la commande (pour savoir quand un chauffeur accepte)
            listenForDriverAssignment(currentOrderId);
        })
        .catch((error) => {
            console.error("Erreur lors de l'enregistrement de la commande:", error);
            alert('Une erreur est survenue. Veuillez réessayer.');
        });
});

// Écouter l'attribution d'un chauffeur
function listenForDriverAssignment(orderId) {
    const orderRef = database.ref('orders/' + orderId);
    orderRef.on('value', (snapshot) => {
        const orderData = snapshot.val();
        if (orderData && orderData.status === 'accepted' && orderData.driverId) {
            // Récupérer les informations du chauffeur
            database.ref('drivers/' + orderData.driverId).once('value')
                .then((driverSnapshot) => {
                    if (driverSnapshot.exists()) {
                        const driverData = driverSnapshot.val();
                        displayDriverInfo(driverData);
                    }
                })
                .catch((error) => {
                    console.error("Erreur lors de la récupération des informations du chauffeur:", error);
                });
        }
    });
}

// Afficher les informations du chauffeur
function displayDriverInfo(driver) {
    driverName.textContent = driver.firstName + ' ' + driver.lastName;
    driverPhone.textContent = driver.phone;
    driverPlate.textContent = driver.plateNumber || 'N/A';
    driverAssignedModal.style.display = 'block';
}

// Fermer le modal du chauffeur
acknowledgeDriverBtn.addEventListener('click', () => {
    driverAssignedModal.style.display = 'none';
});

// Gérer le menu mobile
hamburger.addEventListener('click', () => {
    mobileNav.classList.toggle('active');
    navOverlay.classList.toggle('active');
});

navOverlay.addEventListener('click', () => {
    mobileNav.classList.remove('active');
    navOverlay.classList.remove('active');
});

// Initialiser l'application
document.addEventListener('DOMContentLoaded', () => {
    checkUserRegistration();
});
</script>
</body>
</html>
